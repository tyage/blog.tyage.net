<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>COOPがタイミング系のXS-Searchの緩和策にもなるらしい</title>
<meta name=description content><meta name=keywords content><meta property="og:url" content="https://blog.tyage.net/post/2024/2024-07-18-xs-search-vs-coop/"><meta property="og:type" content="website"><meta property="og:title" content="COOPがタイミング系のXS-Searchの緩和策にもなるらしい"><meta property="og:description" content><meta property="og:image" content="https://blog.tyage.net/icon/icon.jpg"><meta property="og:image:secure_url" content="https://blog.tyage.net/icon/icon.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="COOPがタイミング系のXS-Searchの緩和策にもなるらしい"><meta name=twitter:description content><meta property="twitter:domain" content="https://blog.tyage.net/post/2024/2024-07-18-xs-search-vs-coop/"><meta property="twitter:url" content="https://blog.tyage.net/post/2024/2024-07-18-xs-search-vs-coop/"><meta name=twitter:image content="https://blog.tyage.net/icon/icon.jpg"><link rel=canonical href=https://blog.tyage.net/post/2024/2024-07-18-xs-search-vs-coop/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.9a920d7dabdbad8363b6a0a94e29a9dfebdb7ee64cfcb193a0145e512ef2bdab.js integrity="sha256-mpINfavbrYNjtqCpTimp3+vbfuZM/LGToBReUS7yvas="></script><link rel=webmention href=https://webmention.io/blog.tyage.net/webmention><link rel=pingback href=https://webmention.io/blog.tyage.net/xmlrpc><link rel=stylesheet type=text/css href=/css/style.css><script src=/js/redirect.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-C64TPJYY96"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-C64TPJYY96")</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1507795450221855" crossorigin=anonymous></script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://blog.tyage.net/><img src=/icon/icon.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://blog.tyage.net/>blog.tyage.net</a></div><div class=nav-links><div class=nav-link><a href=https://blog.tyage.net/post><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://blog.tyage.net/index.xml><span data-feather=rss></span> RSS</a></div><div class=nav-link><a href=https://tyage.net><span data-feather=home></span> About me</a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target"></span>
<a><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://blog.tyage.net/post><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://blog.tyage.net/index.xml><span data-feather=rss></span> RSS</a></li><li class=nav-item><a href=https://tyage.net><span data-feather=home></span> About me</a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>COOPがタイミング系のXS-Searchの緩和策にもなるらしい</h1><small role=doc-subtitle></small><p class=post-date>2024/07/18</p><ul class=post-tags></ul></div><div class=post-content><p>XS-Search/XS-Leaksのテクニックは数多くあるけれど、別ウィンドウ/フレームのリソースの読み込み時間を別オリジンから計測するのがよく知られていると思う。</p><p>が、Cookieの<code>SameSite=Lax</code>がデフォルトとなった現代では<code>iframe</code>や<code>fetch</code>による計測が難しくなってしまった。</p><p><img src=defense.png alt="defense table"></p><p>ref: <a href=https://xsleaks.dev/docs/attacks/timing-attacks/network-timing/#defense>https://xsleaks.dev/docs/attacks/timing-attacks/network-timing/#defense</a></p><p>ということで現状汎用的に一番使いやすいのは<code>window.open()</code>を利用して、サーバがレスポンスを生成するのに何秒かかるかを計測するテクニック(先ほどのテーブルで言う<code>Cross-window Timing</code>)になる。</p><p>これは新規ウィンドウに開いた別オリジンの<code>window.origin</code>にアクセスして確認する手法で、もしサーバからレスポンスが返ってきていないならそれはopenerのオリジンになるし、レスポンスが返ってきたあとなら例外が投げられるので計測できるというもの。</p><p>要は、何秒後に<code>window.origin</code>にアクセスできなくなるかを計測している。</p><p>ref: <a href=https://xsleaks.dev/docs/attacks/timing-attacks/network-timing/#cross-window-timing-attacks>https://xsleaks.dev/docs/attacks/timing-attacks/network-timing/#cross-window-timing-attacks</a></p><p>これに対する対策としてはサーバ側で<code>Sec-Fetch-Site</code>を確認するとか様々あるけれど、先程のテーブルを見てみると、COOP(<code>Cross-Origin-Opener-Policy</code>)が有効な防御策として記載されているのが気になった。</p><p>COOPはウィンドウのopenerと新規に開かれたウィンドウのプロセス分離するもので、これによって開いたウィンドウ内のiframeの数を数えたり、開いたウィンドウを更に別のURLに遷移させるといったことができなくなる。</p><p>MDNにも<code>XS-Leaks</code>の対策になるということが書いてある。</p><blockquote><p>COOP will process-isolate your document and potential attackers can&rsquo;t access your global object if they were to open it in a popup, preventing a set of cross-origin attacks dubbed XS-Leaks.</p></blockquote><p>ref: <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cross-Origin-Opener-Policy>https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cross-Origin-Opener-Policy</a></p><p>しかし、これは新規ウィンドウの<code>window.origin</code>にアクセスできなくなるタイミングを計測する、Cross-window Timing Attackを防ぐものではない。</p><p>実際、COOPが<code>same-origin</code>のサイトの読み込み時間をクロスオリジンから計測できている。
(画像では<a href="https://labs.jxck.io/site-isolation/cross-origin-opener-policy/index.html?coop=same-origin">jxckさんのデモサイト</a>を利用)</p><p><img src=measure.png alt="measure time"></p><p>XS-Leaks wikiのコミットログを見ていると、<a href=https://github.com/xsleaks/wiki/pull/92>過去の大規模変更の際に特にコメントなく変更が入っていた</a>ので、これは間違いなのではないかと考えた。</p><p>が、<a href=https://github.com/xsleaks/wiki/pull/165>PR</a>を投げてみたところ、Defense表のチェックボックスは攻撃の緩和策にも付けているということだった。</p><p>COOPはクロスオリジンからの時間計測そのものを防げないのに緩和策になるというのはどういうことか。</p><p>これは実際にXS-Searchによって攻撃する時のことを考えてみるとわかる話だった。</p><p>XS-Searchでは時間計測をすることそのものが目的ではなく、複数のURLのレスポンス時間をオラクルに隠された情報を入手するのが目的となる。</p><p>そのため、普通は複数のURLにアクセスする必要があるのだが、Cross-window Timingの場合開いたウィンドウを使いまわすか、毎回新規ウィンドウを開くかどちらかということになる。</p><p>後者の方法は、CTFのXSS問題でよく利用されるpuppeteerなんかでは制限なくできてしまうが、現実的には開くウィンドウ分のユーザインタラクションか、サイトのポップアップ許可が必要になる（たぶんほとんどのブラウザがそうかも？）。</p><p>となると前者の方法、ウィンドウの使い回しが必要となるわけだが、COOPが設定されているとレスポンスが返ってきた瞬間これができなくなってしまう。
こういうわけで、COOPがタイミング系のXS-Searchに対して意図してかせずか有効な緩和策となるということであった。</p><p>まとめるとこんな感じ。</p><ol><li>XS-Searchで複数のURLのレスポンス時間の差異が知りたい</li><li>複数のURLにアクセスしないといけない</li><li>COOPがあると、開いたウィンドウを再利用できない</li><li>複数のウィンドウを開くには、ユーザが開くウィンドウ分クリックするか、サイトのポップアップを許可する必要がある</li><li>結果、Cross-window TimingのXS-Searchが難しくなる</li></ol><p>もちろん緩和策なので完璧な対策ではなく、少量のURLならユーザインタラクションを通じて計測結果が得られることもあると思う。</p><p>他にも、ほとんどのURLはレスポンスに5秒以上かかるが、一部のURLはすぐにレスポンスが返ってくる、みたいな条件の場合には、レスポンスが3秒以上返ってこなかった場合にはCOOPを受信する前にウィンドウを次のURLに遷移させることで、すぐにレスポンスが返ってくるURLを知ることができそうではある。</p><p>ともかく、COOPのウィンドウを分離する仕組みによって、現実的な条件では緩和策になるという話であった。</p></div><div class=prev-next><div class=prev-post><p><a href=/post/2024/2024-07-11-bridgy-fed/>&#8592;
Previous:</a></p><p class=prev-post-date>2024/07/11</p></div></div><svg id="btt-button" class="arrow-logo" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script><div id=comments><script src=/js/webmention.min.js data-max-webmentions=60 async></script><div id=webmentions></div></div></div></main><footer class=footer><span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a></span></footer></body></html>