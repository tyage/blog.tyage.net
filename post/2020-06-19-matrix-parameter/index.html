<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width"><script type=application/javascript src=https://blog.tyage.net/js/theme-mode.js></script>
<link rel=stylesheet href=https://blog.tyage.net/css/frameworks.min.css><link rel=stylesheet href=https://blog.tyage.net/css/github.min.css><link rel=stylesheet href=https://blog.tyage.net/css/github-style.css><link rel=stylesheet href=https://blog.tyage.net/css/light.css><link rel=stylesheet href=https://blog.tyage.net/css/dark.css><link rel=stylesheet href=https://blog.tyage.net/css/syntax.css><title>Security filter bypasses with "matrix variables" - blog.tyage.net</title><link rel=icon type=image/x-icon href=https://blog.tyage.net/images/favicon.ico><meta name=theme-color content="#1e2327"><script>const match=location.search.match(/^\?p=(\d+)$/);if(location.pathname==="/"&&match!==null){const e=match[1];history.replaceState({previousUrl:location.href},"",`/p${e}/`),location.reload()}else history.state!==null&&history.state.previousUrl&&history.replaceState({},"",history.state.previousUrl)</script><style>.blog-post p{line-height:1.8}</style><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1507795450221855" crossorigin=anonymous></script></head><body><div style=position:relative><header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on"><div class="Header-item mobile-none" style=margin-top:-4px;margin-bottom:-4px><a class=Header-link href=https://blog.tyage.net/><svg class="octicon" height="32" viewBox="0 0 16 16" width="32"><path fill-rule="evenodd" d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.013 8.013.0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a></div><div class="Header-item d-md-none"><button class="Header-link btn-link js-details-target" type=button onclick='document.querySelector("#header-search").style.display=document.querySelector("#header-search").style.display=="none"?"block":"none"'><svg height="24" class="octicon octicon-three-bars" viewBox="0 0 16 16" width="24"><path fill-rule="evenodd" d="M1 2.75A.75.75.0 011.75 2h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 2.75zm0 5A.75.75.0 011.75 7h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 7.75zM1.75 12a.75.75.0 100 1.5h12.5a.75.75.0 100-1.5H1.75z"/></svg></button></div><div style=display:none id=header-search class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex"><div class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to"><div class=position-relative><form target=_blank action=https://www.google.com/search accept-charset=utf-8 method=get autocomplete=off><label class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center"><input type=text class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable" name=q placeholder=Search autocomplete=off>
<input type=hidden name=q value=site:https://blog.tyage.net/></label></form></div></div></div><div class="Header-item Header-item--full flex-justify-center d-md-none position-relative"><a class=Header-link href=https://blog.tyage.net/><svg class="octicon octicon-mark-github v-align-middle" height="32" viewBox="0 0 16 16" width="32"><path fill-rule="evenodd" d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.013 8.013.0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a></div><div class=Header-item style=margin-right:0><a href=javascript:void(0) class="Header-link no-select" onclick=switchTheme()><svg style="fill:var(--color-profile-color-modes-toggle-moon)" class="no-select" viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" clip-rule="evenodd" d="M4.52208 7.71754c3.05612.0 5.53362-2.47748 5.53362-5.5336C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961 9.95801 1.07727 10.3495.771159 10.6474.99992c1.4679 1.12724 2.4141 2.90007 2.4141 4.89391.0 3.40575-2.7609 6.16667-6.16665 6.16667-2.94151.0-5.40199-2.0595-6.018122-4.81523C.794841 6.87902 1.23668 6.65289 1.55321 6.85451 2.41106 7.40095 3.4296 7.71754 4.52208 7.71754z"/></svg></a></div></header></div><div><main><div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4"><div class=px-0><div class="mb-3 d-flex px-3 px-md-3 px-lg-5"><div class="flex-auto min-width-0 width-fit mr-3"><div class=d-flex><div class="d-none d-md-block"><a class="avatar mr-2 flex-shrink-0" href=https://blog.tyage.net/><img class=avatar-user src=/icon/icon.jpg width=32 height=32></a></div><div class="d-flex flex-column"><h1 class="break-word f3 text-normal mb-md-0 mb-1"><span class=author><a href=https://blog.tyage.net/>tyage</a></span><span class=path-divider>/</span><strong class="css-truncate-target mr-1" style=max-width:410px><a href=https://blog.tyage.net/post/2020-06-19-matrix-parameter/>Security filter bypasses with "matrix variables"</a></strong></h1><div class="note m-0">Created <relative-time datetime="Fri, 19 Jun 2020 09:28:25 +0900" class=no-wrap>Fri, 19 Jun 2020 09:28:25 +0900</relative-time></div></div></div></div></div></div></div><div class="container-lg px-3 new-discussion-timeline"><div class="repository-content gist-content"><div><div class="js-gist-file-update-container js-task-list-container file-box"><div id=file-pytest class="file my-2"><div id=post-header class="file-header d-flex flex-md-items-center flex-items-start sticky-header" style=z-index:2><div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto"><div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0"><summary id=toc-toggle onclick=clickToc() class="btn btn-octicon m-0 mr-2 p-2"><svg aria-hidden="true" viewBox="0 0 16 16" height="16" width="16" class="octicon octicon-list-unordered"><path fill-rule="evenodd" d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75.0 000 1.5h8.5a.75.75.0 000-1.5h-8.5zm0 5a.75.75.0 000 1.5h8.5a.75.75.0 000-1.5h-8.5zm0 5a.75.75.0 000 1.5h8.5a.75.75.0 000-1.5h-8.5zM3 8A1 1 0 111 8a1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z"/></svg></summary><details-menu class=SelectMenu id=toc-details style="display: none;"><div class="SelectMenu-modal rounded-3 mt-1" style=max-height:340px><div class="SelectMenu-list SelectMenu-list--borderless p-2" style=overscroll-behavior:contain id=toc-list></div></div></details-menu>983 Words</div><div class="file-actions flex-order-2 pt-0"></div></div></div><div class="Box-body px-5 pb-5" style=z-index:1><article class="markdown-body entry-content container-lg"><p>Spring framework, which is a popular web application framework for Java, supports <a href=https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html#mvc-ann-matrix-variables>&ldquo;matrix variables&rdquo;</a>.</p><p>With matrix variables, we can set the values of parameters in the path segment.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// GET /owners/42;q=11/pets/21;q=22
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/owners/{ownerId}/pets/{petId}&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>findPet</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@MatrixVariable</span><span style=color:#f92672>(</span>name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;q&#34;</span><span style=color:#f92672>,</span> pathVar<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ownerId&#34;</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>int</span> q1<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@MatrixVariable</span><span style=color:#f92672>(</span>name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;q&#34;</span><span style=color:#f92672>,</span> pathVar<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;petId&#34;</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>int</span> q2<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// q1 == 11
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// q2 == 22
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><em><a href=https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html#mvc-ann-matrix-variables>source</a></em></p><p>Some of you may have seen the URIs that contain session ID such as <code>http://example.com/login;jsessionid=XXXXXXX</code> .
The important point is that matrix variables can appear not only in the last part of the URI but also in the middle part of the URI (e.g. <code>http://example.com/foo;p=1/bar;q=22</code>).
If you want to extract the path info from raw URI in order to filter the access, you have to remove matrix variables exactly.
Therefore, if you truncate all characters appears after the semicolon by mistake, your filter can&rsquo;t handle the request correctly which contains matrix variables in the middle part of URI.</p><p>When I worked in my previous company, I and co-workers found some library and web servlet couldn&rsquo;t handle the paths which contains matrix variables correctly.
I could exploit those bugs to bypass authentication under some conditions.</p><p>I&rsquo;ll introduce the vulnerabilities I reported: CVE-2020-1957 (authentication bypass in Apache Shiro) and CVE-2020-1757 (security bypass in Undertow).</p><h2 id=cve-2020-1957>CVE-2020-1957</h2><p>CVE-2020-1957 is the bug found in Apache Shiro when used with the Spring Framework.
Apache Shiro is a security framework that provides authentications, authorization, and so on.
With Shiro, we can easily implement the authentication filter so that we can restrict the access to some endpoints from normal users.</p><p>Let&rsquo;s see the sample application officially provided: <a href=https://github.com/apache/shiro/tree/master/samples/spring-hibernate>https://github.com/apache/shiro/tree/master/samples/spring-hibernate</a> .
In this app, <a href=https://github.com/apache/shiro/blob/2e297858be85ffe95b9d2066dd6287643b32b492/samples/spring-hibernate/src/main/webapp/WEB-INF/applicationContext.xml>applicationContext.xml</a> defines that only authenticated users can visit the URI like <code>/s/**</code>. Users can&rsquo;t access <code>http://localhost:9080/s/home</code> without login.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;bean</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;shiroFilter&#34;</span> <span style=color:#a6e22e>class=</span><span style=color:#e6db74>&#34;org.apache.shiro.spring.web.ShiroFilterFactoryBean&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;property</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;filterChainDefinitions&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;value&gt;</span>
</span></span><span style=display:flex><span>            /s/signup = anon
</span></span><span style=display:flex><span>            /s/manageUsers = perms[user:manage]
</span></span><span style=display:flex><span>            /s/** = authc
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/property&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/bean&gt;</span>
</span></span></code></pre></div><p><em><a href=https://github.com/apache/shiro/blob/2e297858be85ffe95b9d2066dd6287643b32b492/samples/spring-hibernate/src/main/webapp/WEB-INF/applicationContext.xml#L123>source</a></em></p><p>When I looked into the Shiro, I found the following method which truncates the characters appears after semicolon.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> String <span style=color:#a6e22e>decodeAndCleanUriString</span><span style=color:#f92672>(</span>HttpServletRequest request<span style=color:#f92672>,</span> String uri<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    uri <span style=color:#f92672>=</span> decodeRequestString<span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> uri<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> semicolonIndex <span style=color:#f92672>=</span> uri<span style=color:#f92672>.</span><span style=color:#a6e22e>indexOf</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#39;;&#39;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>semicolonIndex <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>?</span> uri<span style=color:#f92672>.</span><span style=color:#a6e22e>substring</span><span style=color:#f92672>(</span><span style=color:#ae81ff>0</span><span style=color:#f92672>,</span> semicolonIndex<span style=color:#f92672>)</span> <span style=color:#f92672>:</span> uri<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><em><a href=https://github.com/apache/shiro/blob/fa1686d0a9fc5914e8dfc6eb92d82c6e4f12be41/web/src/main/java/org/apache/shiro/web/util/WebUtils.java#L234>source</a></em></p><p>Also, URI string which contains <code>../</code> is normalized <strong>after</strong> it is cleaned. I&rsquo;d also note that <code>HttpServletRequest.getRequestURI()</code> returns the requested URI as it is.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> String <span style=color:#a6e22e>getRequestUri</span><span style=color:#f92672>(</span>HttpServletRequest request<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    String uri <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>String<span style=color:#f92672>)</span> request<span style=color:#f92672>.</span><span style=color:#a6e22e>getAttribute</span><span style=color:#f92672>(</span>INCLUDE_REQUEST_URI_ATTRIBUTE<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>uri <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        uri <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span><span style=color:#a6e22e>getRequestURI</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> normalize<span style=color:#f92672>(</span>decodeAndCleanUriString<span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> uri<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><em><a href=https://github.com/apache/shiro/blob/fa1686d0a9fc5914e8dfc6eb92d82c6e4f12be41/web/src/main/java/org/apache/shiro/web/util/WebUtils.java#L141>source</a></em></p><p>So, if the request URI is <code>http://localhost:8090/FOO/../BAR</code>, Shiro cleans it and thinks it should be <code>http://localhost:8090/BAR</code>. But if the URI is <code>http://localhost:8090/FOO;/../BAR</code>, Shiro thinks it is <code>http://localhost:8090/FOO</code> and applies the filter for <code>/FOO</code>.</p><p>As a result, I could bypass the authentication filter in the sample application with this command: <code>curl 'http://localhost:9080/unauthorized;/../s/home' --path-as-is</code>. It shows the home page without login because Shiro does not restrict the access to <code>/unauthorized</code> and Spring returns the result of <code>/s/home</code>!</p><p>To make it more clear, I will show how Shiro and Spring Framework treat this request URI.</p><table><thead><tr><th></th><th>URI</th></tr></thead><tbody><tr><td>Original request</td><td><code>http://localhost:8090/unauthorized;/../s/home</code></td></tr><tr><td>Shiro</td><td><code>http://localhost:8090/unauthorized</code></td></tr><tr><td>Spring Framework</td><td><code>http://localhost:8090/s/home</code></td></tr></tbody></table><h3 id=timeline>Timeline</h3><ul><li>2020/03/04: The issue was reported to <a href=mailto:security@shiro.apache.org>security@shiro.apache.org</a></li><li>2020/03/04: Shiro maintainers confirmed and handled the bug</li><li>2020/03/23: <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-1957">Patched and announcement released</a></li></ul><h2 id=cve-2020-1757>CVE-2020-1757</h2><p>Undertow is a Java based web server and CVE-2020-1757 is the flaw found in Undertow when used with the Spring Framework.
With <a href=https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-undertow>spring-boot-starter-undertow</a>, you can use Spring Framework with this framework.
If your request filter uses <code>request.getReuqestURI()</code> or <code>request.getServletPath()</code>, it may be bypassed.</p><p>I prepared a <a href=https://github.com/tyage/spring-undertow-sample-app>simple application here</a>.
In this app, DemoInterceptor allows the requests only if their paths start with <code>/api/public</code>.
Therefore, nobody can&rsquo;t access <code>http://localhost:9000/secret</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DemoInterceptor</span> <span style=color:#66d9ef>extends</span> HandlerInterceptorAdapter <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>preHandle</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> HttpServletRequest request<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> HttpServletResponse response<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> Object handler<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        String uri <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span><span style=color:#a6e22e>getRequestURI</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>uri<span style=color:#f92672>.</span><span style=color:#a6e22e>startsWith</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/api/public/&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;you are not allowed to access this page!&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><em><a href=https://github.com/tyage/spring-undertow-sample-app/blob/f95747cbdd6b1ab9cd87e8449e1f373c668e33d5/src/main/java/com/example/demo/DemoInterceptor.java>source</a></em></p><p>But this interceptor will be bypassed with this URI <code>http://localhost:9000/api/public/aa;/secret</code> and you can see the secret content.
Let&rsquo;s look into the details.</p><p>First, let&rsquo;s see the result of <code>request.getRequestURI()</code> in DemoInterceptor.
It returns <code>/api/public/aa</code> (note that it isn&rsquo;t <code>/api/public/aa/secret</code>)!.
This is because Undertow thinks that the path segment has ended when it finds a semicolon.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>handlePath</span><span style=color:#f92672>(</span>ByteBuffer buffer<span style=color:#f92672>,</span> ParseState state<span style=color:#f92672>,</span> HttpServerExchange exchange<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> BadRequestException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>next <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;;&#39;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>(</span>parseState <span style=color:#f92672>==</span> START <span style=color:#f92672>||</span> parseState <span style=color:#f92672>==</span> HOST_DONE <span style=color:#f92672>||</span> parseState <span style=color:#f92672>==</span> IN_PATH<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        beginPathParameters<span style=color:#f92672>(</span>state<span style=color:#f92672>,</span> exchange<span style=color:#f92672>,</span> stringBuilder<span style=color:#f92672>,</span> parseState<span style=color:#f92672>,</span> canonicalPathStart<span style=color:#f92672>,</span> urlDecodeRequired<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        handlePathParameters<span style=color:#f92672>(</span>buffer<span style=color:#f92672>,</span> state<span style=color:#f92672>,</span> exchange<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span></code></pre></div><p><em><a href=https://github.com/undertow-io/undertow/blob/ff4c9cf37872cb96070ba6a2fcbbaa6df291e390/core/src/main/java/io/undertow/server/protocol/http/HttpRequestParser.java#L412>source</a></em></p><p>But isn&rsquo;t it weird that Spring Framework calls the method mapped to <code>/secret</code> even though the path in the Undertow is <code>/api/public/aa</code>?
This is because Spring Framework normalizes the path if servlet path and requested path are different.
The comment in <code>getPathWithinServletMapping</code> method says if servlet mapping is <code>/test/*</code> and request URI is <code>/test/a</code>, path in this app will be <code>/a</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Return the path within the servlet mapping for the given request,
</span></span></span><span style=display:flex><span><span style=color:#75715e> * i.e. the part of the request&#39;s URL beyond the part that called the servlet,
</span></span></span><span style=display:flex><span><span style=color:#75715e>   ...
</span></span></span><span style=display:flex><span><span style=color:#75715e> * &lt;p&gt;E.g.: servlet mapping = &#34;/test/*&#34;; request URI = &#34;/test/a&#34; -&gt; &#34;/a&#34;.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   ...
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getPathWithinServletMapping</span><span style=color:#f92672>(</span>HttpServletRequest request<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span></code></pre></div><p><em><a href=https://github.com/spring-projects/spring-framework/blob/4a5063f4c0300d183c8be976dd0c58ce5138032f/spring-web/src/main/java/org/springframework/web/util/UrlPathHelper.java#L207>source</a></em></p><p>As a result, this method returns <code>/secret</code> when a request URL is <code>http://localhost:9000/api/public/aa;/secret</code>.
Following image shows the value of <code>pathWithinApp</code> is <code>"/api/public/aa/secret"</code> and <code>servletPath</code> is <code>"/api/public/aa"</code> and returned path is <code>/secret</code>.</p><p><img src=spring-path-normalize.png alt></p><p>Here is the table again.</p><table><thead><tr><th></th><th>URI</th></tr></thead><tbody><tr><td>Original request</td><td><code>http://localhost:9000/api/public/aa;/secret</code></td></tr><tr><td>Undertow</td><td><code>http://localhost:9000/api/public/aa</code></td></tr><tr><td>Spring Framework</td><td><code>http://localhost:9000/secret</code></td></tr></tbody></table><h3 id=timeline-1>Timeline</h3><ul><li>2019/09/09: The issue was reported to Red Hat Security Team</li><li>2019/11/28: Team tracked the issue</li><li>2020/04/??: <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-1757">CVE issued and announced</a></li></ul><p>It is interesting that <a href=https://issues.redhat.com/browse/UNDERTOW-1464>the issue with matrix variables in Undertow have been reported since 2018</a>, but the issue with Spring Framework has not been reported.</p><h2 id=to-prevent-this-kind-of-attack>To prevent this kind of attack</h2><p>Those issues have been fixed in Shiro 1.5.3 and Undertow 2.1.0 . Your application is safe if you updated them.</p><p>Also, <a href=https://spring.io/projects/spring-security>Spring Security</a> has a firewall that blocks the request contains <code>../</code> or <code>;</code>.
It may be fine if your application installs Spring Security.</p></article></div></div></div></div></div></div></main></div><script type=application/javascript src=https://blog.tyage.net/js/toc.js></script>
<link rel=stylesheet href=https://blog.tyage.net/css/toc.css><div class="footer container-xl width-full p-responsive"><div class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light"><a aria-label=Homepage title=GitHub class="footer-octicon d-none d-lg-block mr-lg-4" href=https://blog.tyage.net/><svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" width="24"><path fill-rule="evenodd" d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.013 8.013.0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a><ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0"><li class="mr-3 mr-lg-0">Theme by <a href=https://github.com/MeiK2333/github-style>github-style</a></li></ul></div><div class="d-flex flex-justify-center pb-6"><span class="f6 text-gray-light"></span></div></div></body><script type=application/javascript src=https://blog.tyage.net/js/github-style.js></script></html>